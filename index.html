<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‘ì—… í”Œë˜ë„ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @media print {
      .no-print {
        display: none !important;
      }
    }
  </style>
</head>

<body>

<!-- ğŸŒ™âœ¨ ì™¼ìª½ ê³ ì • íŒ¨ë„ -->
<div
  id="quick-memo"
  class="quick-memo-panel relative !fixed top-20 left-5 w-[320px] max-w-[90vw] h-[80vh] p-3 rounded-lg shadow-lg
       z-[9999] hidden sm:flex flex-col gap-3
       bg-white text-gray-900
       dark:bg-gray-800 dark:text-gray-100
       border border-gray-300 dark:border-gray-700"
>
 <!-- âœ… ì‚¬ì´ë“œ íŒ¨ë„ ì†ì¡ì´(í† ê¸€) -->
  <button
  id="quick-memo-toggle"
  type="button"
  class="quick-memo-handle absolute -right-4 top-8
         px-3 py-2 rounded-full
         bg-gray-600/90 text-white text-sm font-semibold
         shadow-md backdrop-blur
         hover:bg-gray-500
         active:scale-95 transition-all
         flex items-center justify-center"
  aria-label="ì™¼ìª½ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°"
  title="íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°"
>
â®
</button>

  <!-- ğŸ§© ì˜¤ëŠ˜ í•  ì¼ (ìƒë‹¨) -->
  <div
  class="shrink-0 w-full p-2 rounded-lg
         bg-gray-100 dark:bg-gray-700
         border border-gray-300 dark:border-gray-600"
>
    <div class="text-sm font-semibold mb-1 text-indigo-600 dark:text-indigo-300">
      ğŸ§© ì˜¤ëŠ˜ í•  ì¼
    </div>
    <div id="today-todo-slot" class="w-full"></div>
  </div>

  <!-- âœï¸ ë¹ ë¥¸ ë©”ëª¨ (í•˜ë‹¨) -->
  <div class="flex-1 flex flex-col">
    <h3 class="text-sm font-semibold mb-1 text-indigo-600 dark:text-indigo-300">
      âœï¸ ë¹ ë¥¸ ë©”ëª¨
    </h3>

    <textarea
      id="quickMemoInput"
      class="quick-memo flex-1 resize-none overflow-y-auto p-2 rounded border text-sm
             bg-gray-50 dark:bg-gray-700
             border-gray-300 dark:border-gray-600
             text-gray-900 dark:text-gray-100"
      placeholder="ì§€ê¸ˆ ë– ì˜¤ë¥¸ ìƒê°ì„ ê·¸ëƒ¥ ë˜ì ¸ë†”ë„ ë¼"
    ></textarea>
  </div>
</div>


  <style>
  /* âœ… ì™¼ìª½ íŒ¨ë„: ìŠ¬ë¼ì´ë“œ ì ‘ê¸°/í¼ì¹˜ê¸° */
#quick-memo {
  position: fixed !important;
  top: 5rem;   /* top-20 */
  left: 1.25rem; /* left-5 */
  transition: transform 260ms ease;
  will-change: transform;
}

/* ë‹«í˜ ìƒíƒœ: íŒ¨ë„ ì „ì²´ë¥¼ ì™¼ìª½ìœ¼ë¡œ ë°€ê³ , ì†ì¡ì´(ì•½ 28px)ë§Œ ë‚¨ê¹€ */
#quick-memo.is-collapsed {
  transform: translateX(calc(-100% + 28px));
}
    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œ ì „ì²´ ë°°ê²½ ë° í…ìŠ¤íŠ¸ */
    .dark {
      --tw-bg-opacity: 1;
      background-color: rgb(17 24 39 / var(--tw-bg-opacity));
      /* gray-900 */
      color: #f3f4f6;
      /* gray-100 */
    }

    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œ ë°”ê¹¥ ì—¬ë°±(ì‚¬ì´ë“œ í¬í•¨) */
    .dark body {
      background-color: #0f172a !important;
      /* gray-950 */
      color: #f3f4f6;
    }


    /* â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ ê¸°ë³¸ */
    body:not(.dark) {
      background-color: #f9fafb;
      /* gray-50 */
      color: #111827;
      /* gray-900 */
    }

    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œ ì¹´ë“œí†¤ (gray-850 ëŠë‚Œ) */
    .bg-gray-850 {
      background-color: #1e293b;
    }

    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œ ê·¸ë˜í”„/ìº”ë²„ìŠ¤ ì˜ì—­ */
    .dark canvas,
    .dark .chart-container,
    .dark .recharts-wrapper,
    .dark .graph-area {
      background-color: #1e293b !important;
      /* gray-850 */
      color: #e5e7eb !important;
      border-radius: 0.5rem;
    }

    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œ input/select/date ìƒ‰ìƒ */
    .dark input,
    .dark select,
    .dark textarea {
      background-color: #374151 !important;
      /* gray-700 */
      color: #f3f4f6 !important;
      border-color: #4b5563 !important;
    }
/* âœï¸ ë¹ ë¥¸ ë©”ëª¨ ê¸€ììƒ‰ â€“ ë¶ë§ˆí¬ í†¤ */
.dark #quick-memo textarea {
  color: #A5B4FC !important; /* indigo-500 */
}

    .dark input::placeholder,
    .dark textarea::placeholder {
      color: #9ca3af !important;
      /* gray-400 */
    }

    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œ date-pickerì™€ ì „í›„ ë²„íŠ¼ */
    .dark input[type="date"] {
      background-color: #374151 !important;
      color: #f3f4f6 !important;
      border: 1px solid #4b5563 !important;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
    }

    .dark input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1) brightness(1.2);
    }

    .dark button.bg-gray-200 {
      background-color: #4b5563 !important;
      /* gray-600 */
      color: #e5e7eb !important;
      border: 1px solid #6b7280 !important;
    }

    .dark button.bg-gray-200:hover {
      background-color: #6b7280 !important;
      /* gray-500 */
    }

    /* ğŸŒ™ ìº˜ë¦°ë” ì…€ ìƒ‰ìƒ */
    .dark .calendar-day {
      background-color: #1f2937 !important;
      /* gray-800 */
      color: #e5e7eb !important;
      border: 1px solid #374151 !important;
    }

    .dark .calendar-day.active {
      background-color: #4338ca !important;
      /* indigo-700 */
      color: #ffffff !important;
    }

    .dark .calendar-day.empty {
      background-color: transparent !important;
      border: none !important;
    }

    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œì—ì„œ ê¸€ììƒ‰ì„ ê·¸ë˜í”„ìƒ‰(ë°ì€ íŒŒë‘/ë³´ë¼)ìœ¼ë¡œ í†µì¼ */
    .dark h1,
    .dark h2,
    .dark h3,
    .dark h4,
    .dark h5,
    .dark h6,
    .dark .text-gray-900,
    .dark .text-gray-800,
    .dark .text-gray-700,
    .dark .text-gray-600 {
      color: #818CF8 !important;
      /* Tailwind indigo-400 */
    }

    /* ì„¤ëª… í…ìŠ¤íŠ¸ë‚˜ ì„œë¸Œ í…ìŠ¤íŠ¸ëŠ” ì¡°ê¸ˆ ì—°í•˜ê²Œ */
    .dark .text-gray-500,
    .dark .text-gray-400 {
      color: #A5B4FC !important;
      /* Tailwind indigo-300 */
    }

    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œ ì¹´ë“œ ì œëª© ê°•ì¡° */
    .dark .font-medium,
    .dark .font-semibold,
    .dark h3 {
      color: #A5B4FC !important;
      /* Tailwind indigo-300 */
    }

    /* ì¹´ë“œ ì•ˆì˜ ì‘í’ˆëª… ì „ìš© */
    .dark .text-indigo-700,
    .dark h3.text-indigo-700,
    .dark span.text-indigo-700 {
      color: #C7D2FE !important;
      /* Tailwind indigo-200 ì •ë„ë¡œ ë” ë°ê²Œ */
      font-weight: 600;
    }

    /* ì¹´ë“œ hover ì‹œ ì¢€ ë” ë¶€ë“œëŸ½ê²Œ ë°ì•„ì§€ê²Œ */
    .dark .hover\:text-indigo-400:hover {
      color: #818CF8 !important;
      /* Tailwind indigo-400 */
    }

    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œ â€” ëˆ„ì  í†µê³„ ì„¹ì…˜ ì œëª© ìƒ‰ìƒ */
    .dark h2.text-lg,
    .dark h3.text-md,
    .dark h2.font-semibold,
    .dark h3.font-semibold,
    .dark h2.text-indigo-700,
    .dark h3.text-indigo-700 {
      color: #A5B4FC !important;
      /* Tailwind indigo-300 */
      font-weight: 600;
    }

    /* ğŸŒ™ ëˆ„ì  í†µê³„ì˜ ì•„ì´ì½˜ í…ìŠ¤íŠ¸(ğŸ“˜, ğŸ“† ë“± í¬í•¨)ë„ í†µì¼ */
    .dark h2,
    .dark h3 {
      color: #C7D2FE !important;
      /* Tailwind indigo-200 */
    }

    /* ğŸŒ™ ì„¹ì…˜ ì†Œì œëª© (ì˜ˆ: 'ì´ë²ˆ ë‹¬ ëˆ„ì ', 'ì˜¬í•´ ëˆ„ì ') ì‚´ì§ ë¶€ë“œëŸ½ê²Œ */
    .dark .text-indigo-700 {
      color: #A5B4FC !important;
      /* ë¶€ë“œëŸ¬ìš´ íŒŒìŠ¤í…”í†¤ ë³´ë¼ìƒ‰ */
    }

    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œ â€” ëˆ„ì  í†µê³„ ë¦¬ìŠ¤íŠ¸ ë‚´ ì‘í’ˆëª… ìƒ‰ìƒ ë°ê²Œ */
    .dark ul li span.text-indigo-600,
    .dark ul li span:first-child {
      color: #A5B4FC !important;
      /* indigo-300 â€” ë°ì€ ë³´ë¼ */
      font-weight: 500;
    }

    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œ â€” í†µê³„ ë¦¬ìŠ¤íŠ¸ ìˆ«ì ë¶€ë¶„ì€ ì¡°ê¸ˆ ëœ ë°ê²Œ */
    .dark ul li span:last-child {
      color: #E5E7EB !important;
      /* gray-200 â€” ìˆ«ìëŠ” ì€ì€í•˜ê²Œ */
    }

    /* ğŸŒ™ ë‹¤í¬ëª¨ë“œ - ì‘í’ˆë³„ í‰ê·  ì‘ì„± ì†ë„ & ìµœê³  ìƒì‚°ì¼ ì¹´ë“œ ë‚´ë¶€ í…ìŠ¤íŠ¸ ë°ê²Œ */
    .dark .p-3.border.rounded-lg {
      color: #E0E7FF !important;
      /* text-indigo-100 ë°ì€ ì²­ë³´ë¼ */
    }

    .dark .p-3.border.rounded-lg .text-gray-500,
    .dark .p-3.border.rounded-lg .text-gray-600 {
      color: #C7D2FE !important;
      /* text-indigo-200 â€” ë¼ë²¨ìš© */
    }

    .dark .p-3.border.rounded-lg .font-bold.text-indigo-600,
    .dark .p-3.border.rounded-lg .text-indigo-600 {
      color: #A5B4FC !important;
      /* text-indigo-300 â€” ì£¼ìš” ìˆ˜ì¹˜ */
    }

    .dark .p-3.border.rounded-lg .text-gray-700 {
      color: #E5E7EB !important;
      /* text-gray-200 â€” ì¼ë°˜ í…ìŠ¤íŠ¸ */
    }

    .dark .p-3.border.rounded-lg .text-gray-400 {
      color: #CBD5E1 !important;
      /* text-gray-300 â€” ë³´ì¡° ì„¤ëª… */
    }
   
/* âœ¨ ë‹¤í¬ëª¨ë“œìš© ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í„°ë§ˆì´ì§• */
#quick-memo textarea::-webkit-scrollbar {
  width: 8px;
}

#quick-memo textarea::-webkit-scrollbar-track {
  background: transparent;
}

#quick-memo textarea::-webkit-scrollbar-thumb {
  background-color: rgba(255, 255, 255, 0.2);
  border-radius: 9999px;
  border: 2px solid transparent;
  background-clip: padding-box;
}

#quick-memo textarea::-webkit-scrollbar-thumb:hover {
  background-color: rgba(255, 255, 255, 0.35);
}
  </style>



  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useMemo } = React;

       // âœ… ê¸°ë³¸ ì‘í’ˆ ë¦¬ìŠ¤íŠ¸ (ìµœì´ˆ 1íšŒìš© ê¸°ë³¸ê°’)
    const DEFAULT_PROJECTS = [
      "ë‚«ì¹´í”¼",
      "ìˆ  ëŠê² ìŠµë‹ˆë‹¤",
      "ê·¸ ê³µì‘ì´ ë‚´ êµ¬ì›ì´ ë  ë¦¬ ì—†ì–ì•„",
      "ì„ì‹œ ê°ì¸ ê°€ì´ë“œ",
      "ì‚¬ì‡ì†Œë¦¬",
      "ì´ˆë‹¨í¸",
      "ì´ ê½ƒì˜ ì£¼ì¸ì€ ëˆ„êµ¬?",
      "ê¸°íƒ€"
    ];

    // âœ… localStorageì—ì„œ ì‘í’ˆ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadProjectsFromLocal() {
      try {
        const saved = JSON.parse(localStorage.getItem("writer_projects") || "[]");
        if (Array.isArray(saved) && saved.length > 0) return saved;
      } catch (e) {
        console.error("writer_projects ë¡œë“œ ì‹¤íŒ¨:", e);
      }
      return DEFAULT_PROJECTS;
    }


    const fmtDate = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    };

    const emptyProject = () => ({
      startTime: "",
      startWords: 0,
      logs: [],
    });

    const emptyDay = () => ({});

    function parseKoreanTime(str) {
      const match = str.match(/(ì˜¤ì „|ì˜¤í›„)\s(\d+):(\d+)/);
      if (!match) return 0;
      let [, ampm, hh, mm] = match;
      hh = parseInt(hh, 10);
      mm = parseInt(mm, 10);
      if (ampm === "ì˜¤í›„" && hh !== 12) hh += 12;
      if (ampm === "ì˜¤ì „" && hh === 12) hh = 0;
      return hh * 60 + mm; // ë¶„ ë‹¨ìœ„
    }

    function RoyaltySection({ darkMode }) {
    // ë‚ ì§œ í˜•ì‹ ê°•ì œ ì •ê·œí™” (2026-1-5 â†’ 2026-01-05)


    // ğŸ“Œ ì‘í’ˆë³„ ì¸ì„¸ ëª¨ë‹¬ ìƒíƒœ
  const [royalties, setRoyalties] = React.useState(() => {
    return JSON.parse(localStorage.getItem("writer_royalties") || "[]");
  });
  const [showList, setShowList] = React.useState(false); // âœ… ì¸ì„¸ ë‚´ì—­ ì ‘ê¸°/í¼ì¹˜ê¸°ìš©
// âœ… ìš”ì•½ ê¸°ì¤€ ì—°ë„ (ê¸°ë³¸: ì˜¬í•´)
const now = new Date();
const thisYear = String(now.getFullYear());

const years = Array.from(
  new Set(
    royalties
      .map((r) => normalizeDate(r.date).slice(0, 4))
      .filter(Boolean)
  )
).sort((a, b) => Number(b) - Number(a));

if (!years.includes(thisYear)) years.unshift(thisYear);

const [summaryYear, setSummaryYear] = React.useState(thisYear);
const [showAllTotals, setShowAllTotals] = React.useState(false);

  const emptyRow = {
    date: "",
    title: "",
    type: "ìœ ì—°",
    amount: "",
    tax: "",
    net: "",
    note: "",
  };
  const [newRow, setNewRow] = React.useState(emptyRow);

  const save = (data) => {
    setRoyalties(data);
    localStorage.setItem("writer_royalties", JSON.stringify(data));
    window.dispatchEvent(new Event("royaltyDataUpdated"));
  };

  const addRow = () => {
    if (!newRow.date || !newRow.title || !newRow.amount) {
      alert("ì…ê¸ˆì¼, ì‘í’ˆëª…, ì •ì‚° ê¸ˆì•¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
      return;
    }
    const row = {
      ...newRow,
      amount: Number(newRow.amount || 0),
      tax: Number(newRow.tax || 0),
      net: Number(newRow.net || 0),
    };
    const updated = [...royalties, row];
    save(updated);
    setNewRow(emptyRow);
  };

  const removeRow = (idx) => {
    if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
    const updated = royalties.filter((_, i) => i !== idx);
    save(updated);
  };

  const editRow = (idx) => {
    const updated = [...royalties];
    const r = updated[idx];
    const newAmount = prompt("ì •ì‚° ê¸ˆì•¡ ìˆ˜ì •", r.amount);
    const newTax = prompt("ê³µì œ ì„¸ì•¡ ìˆ˜ì •", r.tax);
    const newNet = prompt("ì‹¤ì…ê¸ˆì•¡ ìˆ˜ì •", r.net);
    const newNote = prompt("ë¹„ê³  ìˆ˜ì •", r.note);
    if (newAmount !== null) r.amount = Number(newAmount || 0);
    if (newTax !== null) r.tax = Number(newTax || 0);
    if (newNet !== null) r.net = Number(newNet || 0);
    if (newNote !== null) r.note = newNote;
    save(updated);
  };

  // ===== ê³„ì‚° =====
 const ym = (d) => normalizeDate(d).slice(0, 7);
const y  = (d) => normalizeDate(d).slice(0, 4);


  const thisYM = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
  const prevDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const prevYM = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, "0")}`;
 
  const monthTotal = royalties
    .filter((r) => ym(r.date) === thisYM)
    .reduce((a, r) => a + Number(r.amount || 0), 0);
  const prevMonthTotal = royalties
    .filter((r) => ym(r.date) === prevYM)
    .reduce((a, r) => a + Number(r.amount || 0), 0);

  let changeText = "ë¹„êµê°’ ì—†ìŒ";
  if (prevMonthTotal > 0) {
    const diffRate = ((monthTotal - prevMonthTotal) / prevMonthTotal) * 100;
    const absRate = Math.abs(diffRate).toFixed(1);
    changeText = diffRate < 0 ? `â–¼ ${absRate}% ê°ì†Œ` : `â–² ${absRate}% ì¦ê°€`;
  }

 // âœ… ì„ íƒ ì—°ë„ ë°ì´í„°ë§Œ ë½‘ê¸°
const yearRows = royalties.filter(
  (r) => normalizeDate(r.date).slice(0, 4) === summaryYear
);

// âœ… ì„ íƒ ì—°ë„ í•©ê³„ (ìš”ì•½ì¤„ì´ ì´ê±¸ë¡œ í†µì¼ë¨)
const yearTotalAmount = yearRows.reduce((a, r) => a + Number(r.amount || 0), 0);
const yearTax = yearRows.reduce((a, r) => a + Number(r.tax || 0), 0);
const yearNet = yearRows.reduce((a, r) => a + Number(r.net || 0), 0);
const yearNonEtcIncome = yearRows
  .filter((r) => r.type !== "ê¸°íƒ€")
  .reduce((a, r) => a + Number(r.amount || 0), 0);

// âœ… ì „ì²´ ëˆ„ì (í† ê¸€ë¡œë§Œ ë³´ì—¬ì¤„ ê°’)
const allTotalAmount = royalties.reduce((a, r) => a + Number(r.amount || 0), 0);
const allTax = royalties.reduce((a, r) => a + Number(r.tax || 0), 0);
const allNet = royalties.reduce((a, r) => a + Number(r.net || 0), 0);
const allNonEtcIncome = royalties
  .filter((r) => r.type !== "ê¸°íƒ€")
  .reduce((a, r) => a + Number(r.amount || 0), 0);

  return (
    <div
      id="royalty-section"
      className={`p-4 mt-6 rounded-2xl shadow ${
        darkMode ? "bg-gray-800 text-gray-200" : "bg-white text-gray-800"
      }`}
    >
      <h2 className="font-semibold text-lg mb-3">ğŸ’° ì¸ì„¸ ê´€ë¦¬</h2>

      {/* ì…ë ¥ í¼ */}
      <div className="grid md:grid-cols-7 gap-2 text-sm mb-3">
        <input
          type="date"
          value={newRow.date}
          onChange={(e) => setNewRow({ ...newRow, date: e.target.value })}
          className="p-2 border rounded"
        />
        <input
          type="text"
          placeholder="ì‘í’ˆëª…"
          value={newRow.title}
          onChange={(e) => setNewRow({ ...newRow, title: e.target.value })}
          className="p-2 border rounded"
        />
        <select
          value={newRow.type}
          onChange={(e) => setNewRow({ ...newRow, type: e.target.value })}
          className="p-2 border rounded"
        >
          <option>ìœ ì—°</option>
          <option>ë‹¨í–‰</option>
          <option>ì´ˆë‹¨</option>
          <option>ê¸°íƒ€</option>
        </select>
        <input
          type="number"
          placeholder="ì •ì‚° ê¸ˆì•¡"
          value={newRow.amount}
          onChange={(e) => setNewRow({ ...newRow, amount: e.target.value })}
          className="p-2 border rounded"
        />
        <input
          type="number"
          placeholder="ê³µì œ ì„¸ì•¡"
          value={newRow.tax}
          onChange={(e) => setNewRow({ ...newRow, tax: e.target.value })}
          className="p-2 border rounded"
        />
        <input
          type="number"
          placeholder="ì‹¤ì…ê¸ˆì•¡"
          value={newRow.net}
          onChange={(e) => setNewRow({ ...newRow, net: e.target.value })}
          className="p-2 border rounded"
        />
        <input
          type="text"
          placeholder="ë¹„ê³ "
          value={newRow.note}
          onChange={(e) => setNewRow({ ...newRow, note: e.target.value })}
          className="p-2 border rounded"
        />
      </div>
      <button
        onClick={addRow}
        className="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm mb-4"
      >
        + ì¸ì„¸ ì¶”ê°€
      </button>

      {/* ìš”ì•½ */}
<div className="text-sm mb-3 leading-6">
  <div>
    ì´ë²ˆ ë‹¬ ì´ ì¸ì„¸:{" "}
    <span className="font-semibold">{monthTotal.toLocaleString()} ì›</span>{" "}
    {prevMonthTotal > 0 ? (
      <span className={/ê°ì†Œ/.test(changeText) ? "text-rose-400" : "text-green-400"}>
        {changeText}
      </span>
    ) : (
      <span className="text-gray-400">({changeText})</span>
    )}
  </div>

  <div className="flex flex-wrap items-center gap-x-2 gap-y-1">
    <span className="text-gray-400">ìš”ì•½ ì—°ë„</span>

    <select
      value={summaryYear}
      onChange={(e) => setSummaryYear(e.target.value)}
      className={`px-2 py-1 rounded border text-sm ${
        darkMode
          ? "bg-gray-900 border-gray-700 text-gray-100"
          : "bg-white border-gray-300 text-gray-900"
      }`}
    >
      {years.map((yy) => (
        <option key={yy} value={yy}>
          {yy}
        </option>
      ))}
    </select>

    <span className="ml-1">
      ì´ ì •ì‚°ê¸ˆì•¡: <b>{yearTotalAmount.toLocaleString()} ì›</b> /
      ì„¸ì•¡ í•©ê³„: {yearTax.toLocaleString()} ì› /
      ëˆ„ì  ì…ê¸ˆì•¡: {yearNet.toLocaleString()} ì› /
      ê¸°íƒ€ ì œì™¸ ìˆ˜ìµ: {yearNonEtcIncome.toLocaleString()} ì›
    </span>

    <button
      onClick={() => setShowAllTotals((v) => !v)}
      className={`ml-auto text-xs underline ${
        darkMode ? "text-indigo-300" : "text-indigo-600"
      }`}
      type="button"
    >
      {showAllTotals ? "ì „ì²´ ëˆ„ì  ìˆ¨ê¸°ê¸°" : "ì „ì²´ ëˆ„ì  ë³´ê¸°"}
    </button>
  </div>

  {showAllTotals && (
    <div className="text-xs text-gray-400 mt-1">
      ì „ì²´ ëˆ„ì : {allTotalAmount.toLocaleString()} ì› /
      ì„¸ì•¡ {allTax.toLocaleString()} ì› /
      ì‹¤ì…ê¸ˆ {allNet.toLocaleString()} ì› /
      ê¸°íƒ€ ì œì™¸ {allNonEtcIncome.toLocaleString()} ì›
    </div>
  )}
</div>


      {/* ì¸ì„¸ ë‚´ì—­ */}
      <div className="flex justify-between items-center mb-2">
        <h3 className="font-semibold text-base">ğŸ“‹ ì¸ì„¸ ë‚´ì—­</h3>
        <button
          onClick={() => setShowList((v) => !v)}
          className={`text-sm ${
            darkMode
              ? "text-indigo-300 hover:text-indigo-100"
              : "text-indigo-600 hover:text-indigo-800"
          }`}
        >
          {showList ? "ì ‘ê¸° â–²" : "í¼ì¹˜ê¸° â–¼"}
        </button>
      </div>

      {showList && (
        royalties.length === 0 ? (
          <p className="text-sm text-gray-500">ë“±ë¡ëœ ì¸ì„¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        ) : (
          <div className="overflow-x-auto">
            <table className="min-w-full text-sm border-t border-gray-700">
              <thead>
                <tr className={darkMode ? "text-indigo-300" : "text-indigo-600"}>
                  <th className="text-left py-2">ì…ê¸ˆì¼</th>
                  <th className="text-left py-2">ì‘í’ˆëª…</th>
                  <th className="text-left py-2">ìœ í˜•</th>
                  <th className="text-left py-2">ì •ì‚° ê¸ˆì•¡</th>
                  <th className="text-left py-2">ê³µì œ ì„¸ì•¡</th>
                  <th className="text-left py-2">ì‹¤ì…ê¸ˆì•¡</th>
                  <th className="text-left py-2">ë¹„ê³ </th>
                  <th className="text-left py-2">ì‚­ì œ</th>
                  <th className="text-left py-2">ìˆ˜ì •</th>
                </tr>
              </thead>
              <tbody>
                {[...royalties]
                  .map((r, idx) => ({ ...r, __idx: idx }))
                  .sort((a, b) => new Date(b.date) - new Date(a.date))
                  .map((r, i) => (
                    <tr key={i}>
                      <td className="py-1">{r.date}</td>
                      <td className="py-1">{r.title}</td>
                      <td className="py-1">{r.type}</td>
                      <td className="py-1">{Number(r.amount || 0).toLocaleString()}</td>
                      <td className="py-1">{Number(r.tax || 0).toLocaleString()}</td>
                      <td className="py-1">{Number(r.net || 0).toLocaleString()}</td>
                      <td className="py-1">{r.note}</td>
                      <td
                        className="py-1 text-red-400 cursor-pointer"
                        onClick={() => removeRow(r.__idx)}
                      >
                        ì‚­ì œ
                      </td>
                      <td
                        className="py-1 text-yellow-400 cursor-pointer"
                        onClick={() => editRow(r.__idx)}
                      >
                        ìˆ˜ì •
                      </td>
                    </tr>
                  ))}
              </tbody>
            </table>
          </div>
        )
      )}
    </div>
  );
}

    function ContractSection({ darkMode }) {
      const [contracts, setContracts] = React.useState(() => {
        const raw = localStorage.getItem("writer_contracts_v1");
        return raw ? JSON.parse(raw) : [];
      });
React.useEffect(() => {
  // âœ… ê¸°ì¡´ ê³„ì•½ ë°ì´í„°ì— division í•„ë“œê°€ ì—†ìœ¼ë©´ ìë™ ì¶”ê°€(ë¹ˆê°’)
  const raw = localStorage.getItem("writer_contracts_v1");
  if (!raw) return;

  const parsed = JSON.parse(raw);
  const needMigrate = Array.isArray(parsed) && parsed.some(c => c.division === undefined);

  if (needMigrate) {
    const migrated = parsed.map(c => ({
      ...c,
      division: c.division ?? "",  // ê¸°ì¡´ ê¸°ë¡ì€ ë¹„ì›Œë‘ê³  ë‚˜ì¤‘ì— ìˆ˜ì • ê°€ëŠ¥
    }));
    setContracts(migrated);
    localStorage.setItem("writer_contracts_v1", JSON.stringify(migrated));
  }
}, []);

      const emptyContract = {
  title: "",
  publisher: "",
  label: "",
  division: "ë‹¨í–‰",     // âœ… ì¶”ê°€: ë‹¨í–‰/ì´ˆë‹¨
  contractDate: "",
  finishDate: "",
  releaseDate: "",
  payDay1: "",
  payDay2: "",
};

      const [newC, setNewC] = React.useState(emptyContract);
      const [editingIndex, setEditingIndex] = React.useState(null);
      const [contractYearFilter, setContractYearFilter] = React.useState("ALL");
      const [divisionFilter, setDivisionFilter] = React.useState("ALL");

      // âœ… ê³„ì•½ì¼(contractDate) ê¸°ì¤€ìœ¼ë¡œ ì—°ë„ ëª©ë¡ ë§Œë“¤ê¸°
const contractYears = React.useMemo(() => {
  const ys = new Set();
  (contracts || []).forEach((c) => {
    const y = (c.contractDate || "").slice(0, 4);
    if (y) ys.add(y);
  });
  return Array.from(ys).sort((a, b) => Number(b) - Number(a)); // ìµœì‹  ì—°ë„ ë¨¼ì €
}, [contracts]);

// âœ… í•„í„° ì ìš©
const filteredContracts = React.useMemo(() => {
  return (contracts || []).filter((c) => {
    const y = (c.contractDate || "").slice(0, 4);
    const okYear = contractYearFilter === "ALL" ? true : y === contractYearFilter;
    const okDiv = divisionFilter === "ALL" ? true : (c.division || "") === divisionFilter;
    return okYear && okDiv;
  });
}, [contracts, contractYearFilter, divisionFilter]);


      const saveContracts = (data) => {
        setContracts(data);
        localStorage.setItem("writer_contracts_v1", JSON.stringify(data));
      };

      const addContract = () => {
        if (!newC.title) return alert("ì‘í’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
        let updated = [...contracts];
        if (editingIndex !== null) {
          updated[editingIndex] = newC;
          setEditingIndex(null);
        } else {
          updated = [...contracts, newC];
        }
        saveContracts(updated);
        setNewC(emptyContract);
      };

      const removeContract = (i) => {
        const updated = [...contracts];
        updated.splice(i, 1);
        saveContracts(updated);
      };

      const editContract = (i) => {
  const row = contracts[i];
  setNewC({ ...row, division: row.division ?? "" });
  setEditingIndex(i);
};

      return (
        <div
          className={`${darkMode
              ? "bg-gray-850 text-gray-200 border-gray-700"
              : "bg-white text-gray-900 border-gray-200"
            } p-4 rounded-lg mb-6`}
        >
          <h2 className="font-semibold text-lg mb-4">ğŸ“‘ ê³„ì•½ ê´€ë¦¬</h2>

          <div className="space-y-4">
            {/* ì…ë ¥ í¼ */}
            <div className="space-y-3">
              <div className="grid md:grid-cols-4 gap-4 text-sm">
  {[
    { label: "ì‘í’ˆëª…", key: "title" },
    { label: "ì¶œíŒì‚¬", key: "publisher" },
    { label: "ë ˆì´ë¸”", key: "label" },
  ].map((f) => (
    <div key={f.key} className="flex flex-col">
      <label className="text-xs font-semibold text-indigo-300 mb-1">
        {f.label}
      </label>
      <input
        type="text"
        value={newC[f.key]}
        onChange={(e) => setNewC({ ...newC, [f.key]: e.target.value })}
        className="p-2 border rounded w-full"
      />
    </div>
  ))}

  {/* âœ… êµ¬ë¶„: ë ˆì´ë¸” ì˜†ì— ì°°ì‹¹ ë¶™ê²Œ ê·¸ë¦¬ë“œ ì•ˆìœ¼ë¡œ */}
  <div className="flex flex-col">
    <label className="text-xs font-semibold text-indigo-300 mb-1">
      êµ¬ë¶„
    </label>
    <select
      value={newC.division || ""}
      onChange={(e) => setNewC({ ...newC, division: e.target.value })}
      className="p-2 border rounded w-32"   // âœ… ì—¬ê¸°ì„œ í­ ì¡°ì ˆ!
    >
      <option value="">ì„ íƒ</option>
      <option value="ë‹¨í–‰">ë‹¨í–‰</option>
      <option value="ì´ˆë‹¨">ì´ˆë‹¨</option>
    </select>
  </div>
</div>

              <div className="grid md:grid-cols-4 gap-4 text-sm">
                <div className="flex flex-col">
                  <label className="text-xs font-semibold text-indigo-300 mb-1">
                    ê³„ì•½ì¼
                  </label>
                  <input
                    type="date"
                    value={newC.contractDate}
                    onChange={(e) =>
                      setNewC({ ...newC, contractDate: e.target.value })
                    }
                    className="p-2 border rounded w-full"
                  />
                </div>
                <div className="flex flex-col">
                  <label className="text-xs font-semibold text-indigo-300 mb-1">
                    ì™„ê³ ì¼
                  </label>
                  <input
                    type="date"
                    value={newC.finishDate}
                    onChange={(e) =>
                      setNewC({ ...newC, finishDate: e.target.value })
                    }
                    className="p-2 border rounded w-full"
                  />
                </div>
                <div className="flex flex-col">
                  <label className="text-xs font-semibold text-indigo-300 mb-1">
                    ì¶œê°„ì¼
                  </label>
                  <input
                    type="date"
                    value={newC.releaseDate}
                    onChange={(e) =>
                      setNewC({ ...newC, releaseDate: e.target.value })
                    }
                    className="p-2 border rounded w-full"
                  />
                </div>
                <div className="flex flex-col">
                  <label className="text-xs font-semibold text-indigo-300 mb-1">
                    ì •ì‚°ì¼ (ë§¤ì›”)
                  </label>
                  <div className="flex gap-2">
                    <input
                      type="number"
                      min="1"
                      max="31"
                      placeholder="ì •ì‚°1"
                      value={newC.payDay1}
                      onChange={(e) =>
                        setNewC({ ...newC, payDay1: e.target.value })
                      }
                      className="p-2 border rounded w-full"
                    />
                    <input
                      type="number"
                      min="1"
                      max="31"
                      placeholder="ì •ì‚°2"
                      value={newC.payDay2}
                      onChange={(e) =>
                        setNewC({ ...newC, payDay2: e.target.value })
                      }
                      className="p-2 border rounded w-full"
                    />
                  </div>
                </div>
              </div>
            </div>

            <div className="flex items-center gap-2">
  <button
    onClick={addContract}
    className="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg"
  >
    + ê³„ì•½ ì¶”ê°€
  </button>

  <a
    href="https://docs.google.com/spreadsheets/d/1uicxyse6FYjxxH5EfwkawUP23fXGP1u4obijsusosEk/edit?usp=sharing"
    target="_blank"
    rel="noopener noreferrer"
    className={`px-4 py-2 rounded-lg font-medium ${
      darkMode
        ? "bg-gray-700 hover:bg-gray-600 text-white"
        : "bg-gray-200 hover:bg-gray-300 text-gray-900"
    }`}
  >
    ğŸ“® íˆ¬ê³  í˜„í™©
  </a>
</div>
{/* âœ… í•„í„°: ê³„ì•½ ì—°ë„ + êµ¬ë¶„ */}
<div className="mt-3 flex flex-wrap items-center gap-3 text-sm">
  <div className="flex items-center gap-2">
    <span className="text-indigo-300 text-xs font-semibold">ê³„ì•½ ì—°ë„</span>
    <select
      value={contractYearFilter}
      onChange={(e) => setContractYearFilter(e.target.value)}
      className="p-2 border rounded w-28"
    >
      <option value="ALL">ì „ì²´</option>
      {contractYears.map((y) => (
        <option key={y} value={y}>{y}</option>
      ))}
    </select>
  </div>

  <div className="flex items-center gap-2">
    <span className="text-indigo-300 text-xs font-semibold">êµ¬ë¶„</span>
    <select
      value={divisionFilter}
      onChange={(e) => setDivisionFilter(e.target.value)}
      className="p-2 border rounded w-28"
    >
      <option value="ALL">ì „ì²´</option>
      <option value="ë‹¨í–‰">ë‹¨í–‰</option>
      <option value="ì´ˆë‹¨">ì´ˆë‹¨</option>
    </select>
  </div>

  <div className="text-xs text-gray-400">
    í‘œì‹œ: <b className="text-gray-200">{filteredContracts.length}</b>ê±´
  </div>
</div>

            {contracts.length === 0 ? (
              <p className="text-sm text-gray-500">ë“±ë¡ëœ ê³„ì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            ) : (
              <table className="w-full text-sm mt-3 border-collapse">
                <thead>
                  <tr className="border-b text-indigo-300">
                    <th>ì‘í’ˆëª…</th>
                    <th>ì¶œíŒì‚¬</th>
                    <th>ë ˆì´ë¸”</th>
                    <th>êµ¬ë¶„</th>
                    <th>ê³„ì•½</th>
                    <th>ì™„ê³ </th>
                    <th>ì¶œê°„</th>
                    <th>ì •ì‚°1</th>
                    <th>ì •ì‚°2</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {filteredContracts.map((c, i) => (
                    <tr key={i} className="border-b hover:bg-gray-800">
                      <td>{c.title}</td>
                      <td>{c.publisher}</td>
                      <td>{c.label}</td>
                      <td>{c.division}</td>
                      <td>{c.contractDate}</td>
                      <td>{c.finishDate}</td>
                      <td>{c.releaseDate}</td>
                      <td>{c.payDay1 && `ë§¤ì›” ${c.payDay1}ì¼`}</td>
                      <td>{c.payDay2 && `ë§¤ì›” ${c.payDay2}ì¼`}</td>
                      <td className="text-right space-x-2">
                        <button
                          onClick={() => editContract(i)}
                          className="text-indigo-400 text-xs"
                        >
                          ìˆ˜ì •
                        </button>
                        <button
                          onClick={() => removeContract(i)}
                          className="text-red-400 text-xs"
                        >
                          ì‚­ì œ
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        </div>
      );
    }

function normalizeDate(dateStr) {
  if (!dateStr) return "";
  const [y, m, d] = dateStr.split("-");
  return `${y}-${m.padStart(2, "0")}-${d.padStart(2, "0")}`;
}

function GoalTimelineSection({ darkMode }) {
  // âœï¸ í˜„ì¬ ìˆ˜ì • ì¤‘ì¸ ëª©í‘œ id
const [editingGoalId, setEditingGoalId] = React.useState(null);
// âœï¸ ìˆ˜ì •ìš© ì„ì‹œ ê°’
const [editGoal, setEditGoal] = React.useState(null);
  // âœ… íƒ€ì„ë¼ì¸ ê¸°ì¤€ (ì „ì²´ ê°„íŠ¸ ê¸°ì¤€ì„ )
  const timelineStart = new Date("2025-12-01");
  const timelineEnd = new Date("2026-03-31");
  const timelineDays =
    (timelineEnd - timelineStart) / (1000 * 60 * 60 * 24);

  // 1ï¸âƒ£ ëª©í‘œ ëª©ë¡
  const [goals, setGoals] = React.useState(() => {
    return JSON.parse(localStorage.getItem("writer_goals") || "[]");
  });

  // 2ï¸âƒ£ ë¹ˆ ëª©í‘œ í…œí”Œë¦¿
  const emptyGoal = {
    id: Date.now(),
    title: "",
    priority: "ì¤‘",
    startDate: "",
    endDate: "",
    tasks: [],
  };

  // 3ï¸âƒ£ ìƒˆ ëª©í‘œ
  const [newGoal, setNewGoal] = React.useState(emptyGoal);

  // 4ï¸âƒ£ ì‘ì—… ì…ë ¥ê°’
  const [taskInputs, setTaskInputs] = React.useState({});

  // 5ï¸âƒ£ ì €ì¥
  React.useEffect(() => {
    localStorage.setItem("writer_goals", JSON.stringify(goals));
  }, [goals]);
const startEditGoal = (goal) => {
  setEditingGoalId(goal.id);
  setEditGoal({ ...goal });
};

const cancelEditGoal = () => {
  setEditingGoalId(null);
  setEditGoal(null);
};

const saveEditGoal = () => {
  setGoals((prev) =>
    prev.map((g) =>
      g.id === editingGoalId ? { ...editGoal } : g
    )
  );
  setEditingGoalId(null);
  setEditGoal(null);
};

  const addGoal = () => {
    if (!newGoal.title || !newGoal.startDate || !newGoal.endDate) {
      alert("ëª©í‘œëª…ê³¼ ê¸°ê°„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      return;
    }

    setGoals([
      ...goals,
      {
        ...newGoal,
        id: Date.now(),
        tasks: [],
      },
    ]);

    setNewGoal({ ...emptyGoal, id: Date.now() });
  };

  const addTask = (goalId) => {
    const title = taskInputs[goalId];
    if (!title) return;

    setGoals((prev) =>
      prev.map((g) =>
        g.id === goalId
          ? {
              ...g,
              tasks: [
                ...g.tasks,
                {
                  id: Date.now(),
                  title,
                  done: false,
                },
              ],
            }
          : g
      )
    );

    setTaskInputs((prev) => ({ ...prev, [goalId]: "" }));
  };

  const toggleTask = (goalId, taskId) => {
    setGoals((prev) =>
      prev.map((g) =>
        g.id === goalId
          ? {
              ...g,
              tasks: g.tasks.map((t) =>
                t.id === taskId ? { ...t, done: !t.done } : t
              ),
            }
          : g
      )
    );
  };

  const removeGoal = (id) => {
    if (!confirm("ì´ ëª©í‘œë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
    setGoals((prev) => prev.filter((g) => g.id !== id));
  };

  // âœ… JSX
  return (
    <div
    id="goal-section"
      className={`p-4 rounded-lg mt-6 ${
        darkMode
          ? "bg-gray-850 text-gray-200 border border-gray-700"
          : "bg-white text-gray-900 border border-gray-200"
      }`}
    >
      <h2 className="font-semibold text-lg mb-4">ğŸ—‚ ëª©í‘œ íƒ€ì„ë¼ì¸</h2>

      {/* ===== ëª©í‘œ ì…ë ¥ ì˜ì—­ ===== */}
      <div className="mb-4 p-3 rounded border border-gray-700 bg-gray-900">
        <div className="flex items-center gap-2">
          <input
            type="text"
            placeholder="ëª©í‘œëª…"
            value={newGoal.title}
            onChange={(e) => setNewGoal({ ...newGoal, title: e.target.value })}
            className="w-2/5 p-2 rounded bg-gray-800 text-white text-sm"
          />

          <select
            value={newGoal.priority}
            onChange={(e) => setNewGoal({ ...newGoal, priority: e.target.value })}
            className="w-[80px] p-2 rounded bg-gray-800 text-white text-sm"
          >
            <option value="ìƒ">ìƒ</option>
            <option value="ì¤‘">ì¤‘</option>
            <option value="í•˜">í•˜</option>
          </select>

          <input
            type="date"
            value={newGoal.startDate}
            onChange={(e) => setNewGoal({ ...newGoal, startDate: e.target.value })}
            className="p-2 rounded bg-gray-800 text-white text-sm"
          />

          <input
            type="date"
            value={newGoal.endDate}
            onChange={(e) => setNewGoal({ ...newGoal, endDate: e.target.value })}
            className="p-2 rounded bg-gray-800 text-white text-sm"
          />

          <button
            onClick={addGoal}
            className="px-3 py-2 rounded bg-indigo-600 text-white text-sm"
          >
            + ì¶”ê°€
          </button>
        </div>
      </div>

      {/* ===== ëª©í‘œ ëª©ë¡ ===== */}
      {goals.length === 0 ? (
        <p className="text-sm text-gray-500">ë“±ë¡ëœ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      ) : (
        <ul className="space-y-4">
          {goals.map((g) => {
            // âœ… ì›” ìë™ ìƒì„± (í—¤ë”ìš©)
            const months = [];
            let cursor = new Date(timelineStart);
            while (cursor <= timelineEnd) {
              months.push(cursor.getMonth() + 1);
              cursor.setMonth(cursor.getMonth() + 1);
            }

            // âœ… ì˜¤ëŠ˜ ë‚ ì§œ ìœ„ì¹˜
            const today = new Date();
            const todayOffset = (today - timelineStart) / (1000 * 60 * 60 * 24);
            const todayLeft = (todayOffset / timelineDays) * 100;

            // âœ… ëª©í‘œ ë°” ê³„ì‚°
            const start = new Date(g.startDate);
            const end = new Date(g.endDate);

            const offsetDays = (start - timelineStart) / (1000 * 60 * 60 * 24);
            const durationDays = (end - start) / (1000 * 60 * 60 * 24);

            const leftPercent = (offsetDays / timelineDays) * 100;
            const widthPercent = (durationDays / timelineDays) * 100;

            return (
              <li
                key={g.id}
                className={`p-4 rounded border ${
                  darkMode
                    ? "border-gray-700 bg-gray-800"
                    : "border-gray-200 bg-gray-50"
                }`}
              >
                <div className="flex gap-6">
                  {/* ===== ì™¼ìª½ ===== */}
                  <div className="w-1/2">
                    <div className="flex justify-between mb-2">
                     {editingGoalId === g.id ? (
  <div className="space-y-1">
    <input
      type="text"
      value={editGoal.title}
      onChange={(e) =>
        setEditGoal({ ...editGoal, title: e.target.value })
      }
      className="w-full p-1 rounded bg-gray-700 text-white text-sm"
    />

    <div className="flex gap-2 text-xs">
      <select
        value={editGoal.priority}
        onChange={(e) =>
          setEditGoal({ ...editGoal, priority: e.target.value })
        }
        className="p-1 rounded bg-gray-700 text-white"
      >
        <option value="ìƒ">ìƒ</option>
        <option value="ì¤‘">ì¤‘</option>
        <option value="í•˜">í•˜</option>
      </select>

      <input
        type="date"
        value={editGoal.startDate}
        onChange={(e) =>
          setEditGoal({ ...editGoal, startDate: e.target.value })
        }
        className="p-1 rounded bg-gray-700 text-white"
      />

      <input
        type="date"
        value={editGoal.endDate}
        onChange={(e) =>
          setEditGoal({ ...editGoal, endDate: e.target.value })
        }
        className="p-1 rounded bg-gray-700 text-white"
      />
    </div>

    <div className="flex gap-2 text-xs mt-1">
      <button
        onClick={saveEditGoal}
        className="text-green-400"
      >
        ì €ì¥
      </button>
      <button
        onClick={cancelEditGoal}
        className="text-gray-400"
      >
        ì·¨ì†Œ
      </button>
    </div>
  </div>
) : (
  <div>
    <div className="font-semibold text-lg">{g.title}</div>
    <div className="text-xs text-gray-400">
  <span className="font-semibold text-gray-200">
    ìš°ì„ ìˆœìœ„: {g.priority}
  </span>
  <span className="mx-1">Â·</span>
  <span>
    {g.startDate} ~ {g.endDate}
  </span>
</div>
  </div>
)}

                      <div className="flex gap-2 text-xs">
  <button
    onClick={() => startEditGoal(g)}
    className="text-blue-400"
  >
    ìˆ˜ì •
  </button>
  <button
    onClick={() => removeGoal(g.id)}
    className="text-red-400"
  >
    ì‚­ì œ
  </button>
</div>

                    </div>

                    <div className="mt-3">
                      <div className="flex gap-2 mb-2">
                        <input
                          type="text"
                          placeholder="ì‘ì—… ì¶”ê°€"
                          value={taskInputs[g.id] || ""}
                          onChange={(e) =>
                            setTaskInputs((prev) => ({
                              ...prev,
                              [g.id]: e.target.value,
                            }))
                          }
                          className="flex-1 p-2 rounded bg-gray-700 text-white text-sm"
                        />
                        <button
                          onClick={() => addTask(g.id)}
                          className="px-2 rounded bg-gray-600 text-white text-sm"
                        >
                          +
                        </button>
                      </div>

                      {g.tasks.length > 0 && (
                        <ul className="space-y-1 text-sm">
                          {g.tasks.map((t) => (
                            <li key={t.id}>
                              <label className="flex gap-2 items-center">
                                <input
                                  type="checkbox"
                                  checked={t.done}
                                  onChange={() => toggleTask(g.id, t.id)}
                                />
                                <span className={t.done ? "line-through text-gray-400" : ""}>
                                  {t.title}
                                </span>
                              </label>
                            </li>
                          ))}
                        </ul>
                      )}
                    </div>
                  </div>

                  {/* ===== ì˜¤ë¥¸ìª½ ê°„íŠ¸ ===== */}
                  <div className="w-1/2">
                    {/* ì›” í—¤ë” */}
                    <div className="flex text-xs text-gray-400 mb-2">
                      {months.map((m, i) => (
                        <div key={i} className="flex-1 text-center">
                          {m}ì›”
                        </div>
                      ))}
                    </div>

                    {/* ê°„íŠ¸ ë°” ì˜ì—­ */}
                    <div className="relative h-12 bg-gray-900 rounded">
                      {/* ì˜¤ëŠ˜ ë‚ ì§œ ë¹¨ê°„ ì„  */}
                      {todayLeft >= 0 && todayLeft <= 100 && (
                        <div
                          className="absolute top-0 bottom-0 w-[2px] bg-red-500"
                          style={{ left: `${todayLeft}%` }}
                        />
                      )}

                      {/* ëª©í‘œ ê¸°ê°„ ë°” */}
                      <div
                        className="absolute top-4 h-4 bg-indigo-500 rounded"
                        style={{
                          left: `${leftPercent}%`,
                          width: `${widthPercent}%`,
                        }}
                      />
                    </div>
                  </div>
                </div>
              </li>
            );
          })}
        </ul>
      )}
    </div>
  );
}
function TodayTodoWidget({ darkMode }) {
  const [items, setItems] = React.useState([]);

  const getTodayKey = () => {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const dd = String(now.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const loadToday = React.useCallback(() => {
  const todayKey = getTodayKey();

  // âœ… localStorageì—ì„œ ìµœì‹  ìº˜ë¦°ë” íˆ¬ë‘ë¥¼ ì§ì ‘ ì½ëŠ”ë‹¤ (ìƒˆë¡œê³ ì¹¨ì—ë„ ì‚´ì•„ë‚¨ìŒ)
  const all = JSON.parse(localStorage.getItem("calendar_tasks") || "{}");
  const raw = all[todayKey] || [];

  const list = raw.map((t) =>
    typeof t === "string"
      ? { id: "legacy_" + t, title: t, time: "", remindMin: 0, done: false }
      : t
  );

  list.sort((a, b) => {
    const at = a.time || "99:99";
    const bt = b.time || "99:99";
    return at.localeCompare(bt);
  });

  setItems(list);
}, []);

  React.useEffect(() => {
    loadToday();

    // ê°™ì€ íƒ­ ë‚´ì—ì„œ ê°±ì‹ ì„ ì¡ì•„ì£¼ê¸° ìœ„í•´ í´ë§(ê°€ë²¼ì›€)
    const t = setInterval(loadToday, 3000);

    // ë‹¤ë¥¸ íƒ­/ì°½ì—ì„œ ë°”ë€Œë©´ storage ì´ë²¤íŠ¸ë¡œë„ ë°˜ì˜
    const onStorage = (e) => {
      if (e.key === "calendar_tasks") loadToday();
    };
    window.addEventListener("storage", onStorage);

    return () => {
      clearInterval(t);
      window.removeEventListener("storage", onStorage);
    };
  }, [loadToday]);

  const todayCount = items.length;
  const doneCount = items.filter((x) => x.done).length;
  const leftCount = todayCount - doneCount;

  return (
    <div
      className={`w-full sm:w-72 rounded-xl border p-3 shadow-sm ${
        darkMode ? "bg-gray-800 border-gray-700 text-gray-200" : "bg-white border-gray-200 text-gray-900"
      }`}
    >
      <div className="flex items-center justify-between mb-2">
               <div className="text-xs opacity-70">
          {leftCount}ê°œ ë‚¨ìŒ / {todayCount}ê°œ
        </div>
      </div>

      {todayCount === 0 ? (
        <div className="text-sm opacity-70">ì˜¤ëŠ˜ì€ ìº˜ë¦°ë”ì— íˆ¬ë‘ê°€ ì—†ì–´ìš”. (í¸ì•ˆâ€¦) ğŸ˜Œ</div>
      ) : (
        <ul className="space-y-2">
          {items.slice(0, 5).map((t, idx) => (
            <li key={t.id || idx} className="flex items-start gap-2">
              <span className="mt-[2px] text-xs opacity-70">{t.time ? t.time : "ì¢…ì¼"}</span>
              <span className={`text-sm ${t.done ? "line-through opacity-60" : ""}`}>
                {t.title}
              </span>
            </li>
          ))}
          {items.length > 5 && (
            <li className="text-xs opacity-70">â€¦ì™¸ {items.length - 5}ê°œ</li>
          )}
        </ul>
      )}

      <div className="mt-2 text-xs opacity-60">
        
      </div>
    </div>
  );
}



    function PlannerApp() {
  const [darkMode, setDarkMode] = React.useState(false);
  const todoRootRef = React.useRef(null);

React.useEffect(() => {
  const slot = document.getElementById("today-todo-slot");
  if (!slot) return;

  if (!todoRootRef.current) {
    todoRootRef.current = ReactDOM.createRoot(slot);
  }

  todoRootRef.current.render(<TodayTodoWidget darkMode={darkMode} />);
}, [darkMode]);

const [activeRoyaltyProject, setActiveRoyaltyProject] = React.useState(null);
      // âœ… ê³„ì •ë³„ ì‘í’ˆ ë¦¬ìŠ¤íŠ¸ (localStorage + Firebase ì—°ë™)
      const [projects, setProjects] = React.useState(() => loadProjectsFromLocal());
      const [newProjectName, setNewProjectName] = React.useState("");
      // âœ… ì‘í’ˆëª… ë³€ê²½ (PlannerApp ì•ˆì—ì„œë§Œ!)
      
// ë‚ ì§œë³„ íˆ¬ë‘ ì €ì¥ì†Œ (localStorage ì—°ë™)
const [calendarTasks, setCalendarTasks] = React.useState(() => {
  return JSON.parse(localStorage.getItem("calendar_tasks") || "{}");
});

React.useEffect(() => {
  localStorage.setItem("calendar_tasks", JSON.stringify(calendarTasks));
}, [calendarTasks]);

// âœ… ì…€ í´ë¦­ ì‹œ ì—¬ëŠ” ëª¨ë‹¬ ìƒíƒœ
const [todoModalOpen, setTodoModalOpen] = React.useState(false);
const [todoModalDate, setTodoModalDate] = React.useState(null);

// âœ… ì €ì¥ ë°˜ì˜
React.useEffect(() => {
  localStorage.setItem("calendar_tasks", JSON.stringify(calendarTasks));
}, [calendarTasks]);

// âœ… ë ˆê±°ì‹œ(ë¬¸ìì—´)ë„ ì•ˆì „í•˜ê²Œ ê°ì²´ë¡œ ìŠ¹ê²©í•´ì„œ ì“°ê¸°
const normalizeTasks = React.useCallback((raw) => {
  return (raw || []).map((t) =>
    typeof t === "string"
      ? { id: "legacy_" + t, title: t, time: "", remindMin: 0, done: false }
      : t
  );
}, []);

// âœ… planner ë³‘í•© (ë¡œì»¬ ë¡œê·¸ê°€ í´ë¼ìš°ë“œ ë®ì–´ì“°ê¸°ë¡œ ë‚ ì•„ê°€ì§€ ì•Šê²Œ)
function dedupLogs(logs) {
  const seen = new Set();
  const out = [];
  for (const l of (logs || [])) {
    const key = `${l.time || ""}||${l.currentWords ?? ""}||${l.diff ?? ""}`;
    if (seen.has(key)) continue;
    seen.add(key);
    out.push(l);
  }
  return out;
}

function mergePlanner(localPlanner, cloudPlanner) {
  const merged = { ...(cloudPlanner || {}) };

  // ë‚ ì§œ ë‹¨ìœ„ ë³‘í•©
  for (const [date, localDay] of Object.entries(localPlanner || {})) {
    const cloudDay = merged[date] || {};
    const dayOut = { ...cloudDay };

    // ì‘í’ˆ ë‹¨ìœ„ ë³‘í•©
    for (const [proj, localProjData] of Object.entries(localDay || {})) {
      const cloudProjData = dayOut[proj] || {};
      const lp = localProjData || {};
      const cp = cloudProjData || {};

      const localLogs = Array.isArray(lp.logs) ? lp.logs : [];
      const cloudLogs = Array.isArray(cp.logs) ? cp.logs : [];

      dayOut[proj] = {
        ...cp,
        ...lp, // ê¸°ë³¸ì€ ë¡œì»¬ ìš°ì„  (ë°©ê¸ˆ ì°ì€ ê°’ ì‚´ë¦¬ê¸°)
        logs: dedupLogs([...cloudLogs, ...localLogs]),

        // ê°’ë“¤ì€ "ìˆëŠ” ìª½" ìš°ì„ ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ
        startTime: lp.startTime || cp.startTime || "",
        startWords: Number.isFinite(lp.startWords) ? lp.startWords : (cp.startWords || 0),
        goal: Number.isFinite(lp.goal) ? lp.goal : (cp.goal || 0),

        // memoëŠ” ë” ê¸´ ìª½ ìš°ì„ (ëŒ€ì¶©ì´ë¼ë„ ë³´ì¡´)
        memo:
          String(lp.memo || "").length >= String(cp.memo || "").length
            ? (lp.memo || "")
            : (cp.memo || ""),
      };
    }

    merged[date] = dayOut;
  }

  return merged;
}

const renameProject = (oldName) => {
  const newNameRaw = prompt("ìƒˆ ì‘í’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”", oldName);
  if (newNameRaw === null) return;

  const newName = newNameRaw.trim();
  if (!newName) return alert("ìƒˆ ì‘í’ˆëª…ì´ ë¹„ì–´ ìˆì–´ìš”.");
  if (newName === oldName) return;
  if (projects.includes(newName)) return alert("ì´ë¯¸ ìˆëŠ” ì‘í’ˆëª…ì…ë‹ˆë‹¤.");

  // âœ… (A) ì‘í’ˆ ë¦¬ìŠ¤íŠ¸ ë³€ê²½: í˜¹ì‹œ ëª¨ë¥¼ ì¤‘ë³µë„ ì œê±°
  setProjects((prev) => {
    const next = prev.map((p) => (p === oldName ? newName : p));
    return Array.from(new Set(next));
  });

  // âœ… (B) ëª©í‘œ(writer_targets)ë„ ê°™ì´ ì´ì‚¬
  try {
    const raw = localStorage.getItem("writer_targets");
    const targets = raw ? JSON.parse(raw) : {};
    if (Object.prototype.hasOwnProperty.call(targets, oldName)) {
      const out = { ...targets };

      // ìƒˆ ì´ë¦„ ëª©í‘œê°€ ë¹„ì–´ìˆì„ ë•Œë§Œ old ëª©í‘œë¥¼ ì˜®ê¹€ (ë®ì–´ì“°ê¸° ë°©ì§€)
      if (!Object.prototype.hasOwnProperty.call(out, newName)) {
        out[newName] = out[oldName];
      }
      delete out[oldName];
      localStorage.setItem("writer_targets", JSON.stringify(out));
    }
  } catch (e) {
    console.warn("writer_targets rename failed:", e);
  }

  // âœ… (C) store í‚¤ ì´ì‚¬: ê°™ì€ ë‚ ì§œì— newNameì´ ì´ë¯¸ ìˆìœ¼ë©´ 'ë³‘í•©' í›„ oldName ì‚­ì œ
  setStore((prev) => {
    const copy = JSON.parse(JSON.stringify(prev || {}));

    const renameLogFields = (log) => {
      if (!log || typeof log !== "object") return log;
      // ë¡œê·¸ êµ¬ì¡°ê°€ ë²„ì „ì— ë”°ë¼ ë‹¬ë¼ì„œ ì•ˆì „í•˜ê²Œ ì—¬ëŸ¬ í•„ë“œë¥¼ ê°™ì´ ì²˜ë¦¬
      const patched = { ...log };
      if (patched.project === oldName) patched.project = newName;
      if (patched.proj === oldName) patched.proj = newName;
      if (patched.name === oldName) patched.name = newName;
      return patched;
    };

    Object.keys(copy).forEach((date) => {
      const dayObj = copy[date];
      if (!dayObj || typeof dayObj !== "object") return;

      const oldData = dayObj[oldName];
      const newData = dayObj[newName];

      // 1) oldName ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì²˜ë¦¬
      if (oldData) {
        // newNameì´ ì´ë¯¸ ìˆìœ¼ë©´ ë³‘í•©
        if (newData) {
          const oldLogs = Array.isArray(oldData.logs) ? oldData.logs : [];
          const newLogs = Array.isArray(newData.logs) ? newData.logs : [];

          // dedupLogsëŠ” ìœ„ì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í•¨ìˆ˜ë¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          const mergedLogs = dedupLogs(
            [...newLogs, ...oldLogs].map(renameLogFields)
          );

          dayObj[newName] = {
            // ê¸°ë³¸ì€ newDataë¥¼ ìš°ì„ ìœ¼ë¡œ ë‘ë˜, oldDataì˜ ê°’ë„ ë³´ì¡´
            ...oldData,
            ...newData,

            logs: mergedLogs,

            // ê°’ë“¤ì€ "ìˆëŠ” ìª½" ìš°ì„ ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ
            startTime: newData.startTime || oldData.startTime || "",
            startWords: Number.isFinite(newData.startWords)
              ? newData.startWords
              : (oldData.startWords || 0),
            goal: Number.isFinite(newData.goal)
              ? newData.goal
              : (oldData.goal || 0),

            // memoëŠ” ë” ê¸´ ìª½ ìš°ì„ 
            memo:
              String(newData.memo || "").length >= String(oldData.memo || "").length
                ? (newData.memo || "")
                : (oldData.memo || ""),
          };
        } else {
          // newNameì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì´ë™
          const moved = { ...oldData };
          if (Array.isArray(moved.logs)) moved.logs = moved.logs.map(renameLogFields);
          dayObj[newName] = moved;
        }

        delete dayObj[oldName];
      }

      // 2) í˜¹ì‹œ newName ë¡œê·¸ ì•ˆì— oldNameì´ ì„ì—¬ ìˆìœ¼ë©´ ì¶”ê°€ ì •ë¦¬
      if (dayObj[newName]?.logs && Array.isArray(dayObj[newName].logs)) {
        dayObj[newName].logs = dayObj[newName].logs.map(renameLogFields);
      }
    });

    return copy;
  });

  // âœ… (D) í˜„ì¬ ì„ íƒ/ëª¨ë‹¬ë„ ê°™ì´ ë°”ê¿”ì£¼ê¸°
  setFilterProject(newName);
  if (activeProject === oldName) setActiveProject(newName);

  alert(`"${oldName}" â†’ "${newName}" ë³€ê²½ ì™„ë£Œ (ê¸°ì¡´ ê¸°ë¡ ë³‘í•©ë¨)`);
};


      // ì‘í’ˆ ë¦¬ìŠ¤íŠ¸ ë³€ê²½ ì‹œ localStorageì— ì €ì¥
      React.useEffect(() => {
        localStorage.setItem("writer_projects", JSON.stringify(projects));
      }, [projects]);

      // âœ… ë‹¤í¬ëª¨ë“œ ë¶ˆëŸ¬ì˜¤ê¸°
      React.useEffect(() => {
        const saved = localStorage.getItem("darkMode");
        if (saved) setDarkMode(saved === "true");
      }, []);

      // âœ… ë‹¤í¬ëª¨ë“œ ì €ì¥
      React.useEffect(() => {
        localStorage.setItem("darkMode", darkMode);
        if (darkMode) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      }, [darkMode]);

      const [tab, setTab] = React.useState("log");
      const [dateStr, setDateStr] = React.useState(fmtDate(new Date()));
      const [store, setStore] = React.useState({});
      const [filterProject, setFilterProject] = React.useState(() => loadProjectsFromLocal()[0] || "");
      const [showLogs, setShowLogs] = React.useState(true);
      const [, forceRender] = React.useState(0);




      // ğŸ§© ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      React.useEffect(() => {
  const raw = localStorage.getItem("writer_planner_store_v4");
  if (!raw) return;

  try {
    const parsed = JSON.parse(raw);

    // âœ… dailySummaryê°€ ê°ì²´ë¡œ ë³€ì§ˆëœ ë ˆê±°ì‹œ ë°ì´í„° ë³µêµ¬
    Object.entries(parsed || {}).forEach(([d, dayObj]) => {
      if (!dayObj || typeof dayObj !== "object") return;

      const ds = dayObj.dailySummary;

      if (typeof ds === "object" && ds !== null) {
        // {text:"..."} í˜•íƒœë©´ text ì‚´ë¦¬ê³ , ì•„ë‹ˆë©´ ë¹ˆ ë¬¸ìì—´ë¡œ
        dayObj.dailySummary = (typeof ds.text === "string") ? ds.text : "";
      } else if (typeof ds !== "string" && ds != null) {
        dayObj.dailySummary = "";
      }

      // í˜¹ì‹œ dailySummaryê°€ "ì‘í’ˆì²˜ëŸ¼" ë‚¨ì•„ì„œ logsê°€ ìˆë‹¤ë©´ ë¬´ì¡°ê±´ ë¬¸ìì—´ë¡œ ë®ì–´ì”€
      if (dayObj.dailySummary && typeof dayObj.dailySummary !== "string") {
        dayObj.dailySummary = "";
      }
    });

    setStore(parsed);
    localStorage.setItem("writer_planner_store_v4", JSON.stringify(parsed)); // âœ… ì •ë¦¬ë³¸ìœ¼ë¡œ ì¦‰ì‹œ ì €ì¥
  } catch (e) {
    console.error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
  }
}, []);

      // ğŸ’¾ ì €ì¥
      React.useEffect(() => {
        localStorage.setItem("writer_planner_store_v4", JSON.stringify(store));
      }, [store]);

      // âœ… ë‚ ì§œë³„/ì‘í’ˆë³„ ë°ì´í„° ì ‘ê·¼
      const day = store[dateStr] ?? emptyDay();
      const setDay = (upd) =>
        setStore((prev) => ({
          ...prev,
          [dateStr]:
            typeof upd === "function"
              ? upd(prev[dateStr] ?? emptyDay())
              : upd,
        }));

      // ğŸ”” ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ë²„íŠ¼(ì›í•˜ë©´ UIë¡œ ë…¸ì¶œ)
function requestNotifyPermission() {
  if (!("Notification" in window)) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
    return;
  }
  if (Notification.permission === "granted") {
    alert("ì´ë¯¸ ì•Œë¦¼ì´ í—ˆìš©ë˜ì–´ ìˆì–´ìš” âœ…");
    return;
  }
  Notification.requestPermission().then((p) => {
    if (p === "granted") alert("ì•Œë¦¼ í—ˆìš© ì™„ë£Œ âœ…");
    else alert("ì•Œë¦¼ì´ ê±°ë¶€ë˜ì—ˆì–´ìš”. (ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë³€ê²½ ê°€ëŠ¥)");
  });
}

// ğŸ”” ì•Œë¦¼ ì—”ì§„: 30ì´ˆë§ˆë‹¤ ì•ìœ¼ë¡œ Në¶„ ë‚´ ì˜ˆì •ëœ íˆ¬ë‘ë¥¼ ì°¾ì•„ì„œ í•œë²ˆë§Œ ë„ì›€
React.useEffect(() => {
  if (!("Notification" in window)) return;

  const NOTIFIED_KEY = "calendar_notified_v1";
  const loadNotified = () => {
    try { return JSON.parse(localStorage.getItem(NOTIFIED_KEY) || "{}"); }
    catch { return {}; }
  };
  const saveNotified = (obj) => localStorage.setItem(NOTIFIED_KEY, JSON.stringify(obj));

  const interval = setInterval(() => {
    // ê¶Œí•œ ì—†ìœ¼ë©´ ì¡°ìš©íˆ íŒ¨ìŠ¤
    if (Notification.permission !== "granted") return;

    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const dd = String(now.getDate()).padStart(2, "0");
    const todayKey = `${yyyy}-${mm}-${dd}`;

    const tasksByDate = JSON.parse(localStorage.getItem("calendar_tasks") || "{}");
    const listRaw = tasksByDate[todayKey] || [];

    // ë¬¸ìì—´/ê°ì²´ í†µì¼
    const list = listRaw.map((t) => (
      typeof t === "string"
        ? { id: "legacy_" + t, title: t, time: "", remindMin: 0, done: false }
        : t
    ));

    const notified = loadNotified();

    list.forEach((t) => {
      if (!t || t.done) return;
      if (!t.time) return; // ì¢…ì¼ì€ ì•Œë¦¼ ì œì™¸(ì›í•˜ë©´ ë°”ê¿”ì¤„ê²Œ)
      const [H, M] = (t.time || "").split(":").map(Number);
      if (!Number.isFinite(H) || !Number.isFinite(M)) return;

      const due = new Date(yyyy, Number(mm) - 1, Number(dd), H, M, 0, 0);
      const remindAt = new Date(due.getTime() - (Number(t.remindMin || 0) * 60 * 1000));

      // ì§€ê¸ˆë¶€í„° 30ì´ˆ ë‚´ì— remindAtì„ "ì§€ë‚˜ì¹˜ëŠ”" ìˆœê°„ì—ë§Œ
      const diff = remindAt.getTime() - now.getTime();
      if (diff <= 30000 && diff >= -30000) {
        const key = `${todayKey}|${t.id}|${t.time}|${t.title}`;
        if (notified[key]) return;

        new Notification("ğŸ”” íˆ¬ë‘ ì•Œë¦¼", {
          body: `${t.time} Â· ${t.title}`,
        });

        notified[key] = Date.now();
        saveNotified(notified);
      }
    });
  }, 30000);

  return () => clearInterval(interval);
}, []);


      const projectData = day[filterProject] ?? emptyProject();
      const setProjectData = (upd) => {
        setDay((cur) => {
          const copy = JSON.parse(JSON.stringify(cur ?? emptyDay()));
          copy[filterProject] =
            typeof upd === "function"
              ? upd(copy[filterProject] ?? emptyProject())
              : upd;
          return copy;
        });
      };

      // ğŸ” ë‚ ì§œ ì „í™˜
      const nextDay = (delta) => {
        const d = new Date(dateStr);
        d.setDate(d.getDate() + delta);
        setDateStr(fmtDate(d));
      };

      // ğŸ§± ë¡œê·¸ ì¶”ê°€
      const addLog = (currentWords) => {
        setProjectData((cur) => {
          const data = JSON.parse(JSON.stringify(cur ?? emptyProject()));
          const logs = data.logs || [];
          const base =
            logs.length > 0
              ? logs[logs.length - 1].currentWords
              : data.startWords || 0;
          const diff = Math.max(0, currentWords - base);
          logs.push({
            time: new Date().toLocaleTimeString("ko-KR", {
              hour: "2-digit",
              minute: "2-digit",
            }),
            currentWords,
            diff,
          });
          data.logs = logs;
          return data;
        });
      };

      // âŒ ë¡œê·¸ ì‚­ì œ
      const removeLog = (idx) => {
        setProjectData((cur) => {
          const data = JSON.parse(JSON.stringify(cur ?? emptyProject()));
          data.logs.splice(idx, 1);
          return data;
        });
      };

      // ğŸ“Š í†µê³„ ê³„ì‚°
      const totalWords = Object.values(day).reduce(
        (sum, proj) =>
          sum + ((proj.logs || []).reduce((s, l) => s + (l.diff || 0), 0)),
        0
      );

      // ğŸ”§ í”„ë¡œì íŠ¸ë³„ í†µê³„ ê³„ì‚° í•¨ìˆ˜ (ì„ì‹œ ë²„ì „)
      function getProjectStats(proj) {
        const projData = day[proj] || emptyProject();
        const logs = projData.logs || [];
        const total = logs.reduce((s, l) => s + (l.diff || 0), 0);

        const sessions = logs.length;
        const avg = sessions > 0 ? Math.round(total / sessions) : 0;

        // ğŸ•’ ëˆ„ì  ì‹œê°„ ê³„ì‚° (ì„¸ì…˜ 1ê°œ = 0.5ì‹œê°„ ê°€ì •)
        const hours = sessions * 0.5;

        // âœ… ì¸ì„¸ ë°ì´í„° ì „ì—­ í†µê³„ ê³„ì‚°
const royalties = JSON.parse(localStorage.getItem("writer_royalties") || "[]");
const grouped = {
  byYear: royalties.reduce((acc, r) => {
    const y = normalizeDate(r.date).slice(0, 4);
    acc[y] = (acc[y] || 0) + Number(r.amount || 0);
    return acc;
  }, {}),
  byTitle: royalties.reduce((acc, r) => {
    const t = r.title || "ë¯¸ì§€ì •";
    acc[t] = (acc[t] || 0) + Number(r.amount || 0);
    return acc;
  }, {})
};

         // ì›”ë³„ í•©ê³„ [ ["2025-10", 123456], ... ]
        let months = Object.entries(
  royalties.reduce((acc, r) => {
    const ym = normalizeDate(r.date).slice(0, 7);
    acc[ym] = (acc[ym] || 0) + Number(r.amount || 0);
    return acc;
  }, {})
).sort(([a], [b]) => a.localeCompare(b));

// ğŸ“Œ ìµœê·¼ 12ê°œì›”ë§Œ ìë¥´ê¸°
if (months.length > 12) {
  months = months.slice(-12);
}
          return {
          total,
          sessions,
          avg,
          hours,
          startTime: projData.startTime || "--:--",
          startCount: projData.startWords || 0,
          goal: 4000,
        };

      }


      // ğŸ”§ í”„ë¡œì íŠ¸ ìƒì„¸ ì—´ê¸° (ì„ì‹œ)
      function openProjectDetail(proj) {
        alert(`${proj} ìƒì„¸ ë³´ê¸° (ì¶”í›„ êµ¬í˜„ ì˜ˆì •)`);
      }

      // ğŸ¬ ì‘í’ˆ ìƒì„¸ ëª¨ë‹¬
      const [activeProject, setActiveProject] = React.useState(null);

      const ProjectModal = ({ proj, onClose }) => {
        const dayData = store[dateStr]?.[proj] || {};
        const logs = dayData.logs || [];
        const total = logs.reduce((sum, l) => sum + (l.diff || 0), 0);
        const sessions = logs.length;
        const avg = sessions > 0 ? Math.round(total / sessions) : 0;

        const [memo, setMemo] = React.useState(dayData.memo || "");

        const saveMemo = () => {
          setStore((prev) => {
            const copy = JSON.parse(JSON.stringify(prev));
            if (!copy[dateStr]) copy[dateStr] = {};
            if (!copy[dateStr][proj]) copy[dateStr][proj] = {};
            copy[dateStr][proj].memo = memo;
            return copy;
          });
        };

        return (

          <div
            className="fixed inset-0 bg-black/40 flex items-center justify-center z-50"
            onClick={onClose} // ë°°ê²½ í´ë¦­ ì‹œ ë‹«í˜
          >
            <div
              className={`${darkMode ? "bg-gray-800 text-gray-400 border-gray-600" : "bg-white text-gray-900 border-gray-300"} p-4 rounded-lg relative`}
              onClick={(e) => e.stopPropagation()} // ë‚´ë¶€ í´ë¦­ì€ ë‹«íˆì§€ ì•ŠìŒ
            >
              <button
                onClick={onClose}
                className="absolute top-3 right-3 text-gray-500 hover:text-gray-800"
              >
                âœ•
              </button>


              <h2 className="text-xl font-bold text-indigo-600 mb-4">{proj}</h2>

              {/* ìš”ì•½ */}
              <div className="grid grid-cols-3 gap-2 text-center mb-4">
                <div>
                  <div className="text-sm text-gray-500">ì´í•©</div>
                  <div className="font-semibold text-indigo-600">
                    {total.toLocaleString()}ì
                  </div>
                </div>
                <div>
                  <div className="text-sm text-gray-500">ì„¸ì…˜</div>
                  <div className="font-semibold">{sessions}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-500">í‰ê· </div>
                  <div className="font-semibold">
                    {avg.toLocaleString()}ì
                  </div>
                </div>

              </div>
              {/* ğŸ“… ìµœê·¼ 7ì¼ ê¸°ë¡ ìš”ì•½ */}
              <div className="mb-4">
                <h3 className="text-sm font-semibold text-indigo-700 mb-2">ğŸ“… ìµœê·¼ 7ì¼ ì§‘í•„ ê¸°ë¡</h3>
                <div className="bg-gray-50 rounded-lg p-3 text-sm">
                  {(() => {
                    const today = new Date(dateStr);
                    const last7 = [];
                    for (let i = 6; i >= 0; i--) {
                      const d = new Date(today);
                      d.setDate(today.getDate() - i);
                      const key = fmtDate(d);
                      const logs = store[key]?.[proj]?.logs || [];
                      const total = logs.reduce((s, l) => s + (l.diff || 0), 0);
                      if (total > 0) last7.push({ date: key.slice(5), total });
                    }

                    if (last7.length === 0)
                      return <p className="text-gray-400 text-xs">ìµœê·¼ 7ì¼ê°„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>;

                    return (
                      <div className="space-y-1">
                        {last7.map((d, i) => (
                          <div
                            key={i}
                            className="flex justify-between border-b border-dashed border-gray-200 last:border-none"
                          >
                            <span>{d.date}</span>
                            <span className="text-indigo-600">{d.total.toLocaleString()}ì</span>
                          </div>
                        ))}
                      </div>
                    );
                  })()}
                </div>
              </div>

              {/* ğŸ“Š ëˆ„ì  ìš”ì•½ */}
              <div className="border-t border-gray-200 pt-3 mb-4 text-sm">
                {(() => {
                  const allDays = Object.entries(store);
                  let total = 0;
                  let sessions = 0;
                  allDays.forEach(([_, data]) => {
                    const logs = data[proj]?.logs || [];
                    total += logs.reduce((s, l) => s + (l.diff || 0), 0);
                    sessions += logs.length;
                  });
                  const avg = sessions > 0 ? Math.round(total / sessions) : 0;

                  return (
                    <div className="grid grid-cols-3 text-center text-gray-700">
                      <div>
                        <div className="text-gray-500 text-xs">ëˆ„ì  ì´í•©</div>
                        <div className="font-semibold text-indigo-600">{total.toLocaleString()}ì</div>
                      </div>
                      <div>
                        <div className="text-gray-500 text-xs">ì„¸ì…˜ ìˆ˜</div>
                        <div className="font-semibold">{sessions}</div>
                      </div>
                      <div>
                        <div className="text-gray-500 text-xs">í‰ê· </div>
                        <div className="font-semibold">{avg.toLocaleString()}ì</div>
                      </div>
                    </div>
                  );
                })()}
              </div>

              {/* ë©”ëª¨ */}
              <div>
                <textarea
                  value={memo}
                  onChange={(e) => setMemo(e.target.value)}
                  className="w-full border rounded-lg p-2 text-sm h-20"
                  placeholder="ì˜¤ëŠ˜ì˜ ì‘ì—… ì†Œê°ì´ë‚˜ ë©”ëª¨ë¥¼ ì ì–´ë³´ì„¸ìš”"
                />
                <button
                  onClick={saveMemo}
                  className="mt-2 px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm"
                >
                  ğŸ’¾ ë©”ëª¨ ì €ì¥
                </button>
              </div>
            </div>
          </div>
        );
      };

// âœ… ì¸ì„¸ ë°ì´í„° ì „ì—­ í†µê³„ ê³„ì‚°
const royalties = JSON.parse(localStorage.getItem("writer_royalties") || "[]");

const grouped = {
  byYear: royalties.reduce((acc, r) => {
    const y = normalizeDate(r.date).slice(0, 4);
    acc[y] = (acc[y] || 0) + Number(r.amount || 0);
    return acc;
  }, {}),
  byTitle: royalties.reduce((acc, r) => {
    const t = r.title || "ë¯¸ì§€ì •";
    acc[t] = (acc[t] || 0) + Number(r.amount || 0);
    return acc;
  }, {}),
};

      return (
        <div
          className={`max-w-4xl mx-auto p-6 transition-colors duration-300 ${darkMode ? "bg-gray-900 text-gray-300" : "bg-gray-50 text-gray-900"
            }`}
        >

          <h1 className="text-2xl sm:text-3xl font-bold mb-6">ì‘ì—… í”Œë˜ë„ˆ</h1>






          {/* ğŸ”¸ ë‚ ì§œ + ì‘í’ˆ ì„ íƒ + ë¼ì´íŠ¸ëª¨ë“œ ë²„íŠ¼ */}
                    <div className="flex flex-col gap-2 mb-4">
            {/* 1ì¤„ì°¨: ë‚ ì§œ, ì‘í’ˆ ì„ íƒ, ë‹¤í¬ëª¨ë“œ */}
            <div className="flex items-center justify-between gap-3">
              {/* ì™¼ìª½ ê·¸ë£¹: ë‚ ì§œ ì´ë™ */}
              <div className="flex items-center gap-2">
                <button onClick={() => nextDay(-1)} className="px-3 py-1 bg-gray-200 rounded-lg">â—€</button>
                <input
                  type="date"
                  value={dateStr}
                  onChange={(e) => setDateStr(e.target.value)}
                  className="border rounded-lg p-2"
                />
                <button onClick={() => nextDay(1)} className="px-3 py-1 bg-gray-200 rounded-lg">â–¶</button>
              </div>

              {/* ê°€ìš´ë°: ì‘í’ˆ ì„ íƒ */}
              <select
                value={filterProject}
                onChange={(e) => setFilterProject(e.target.value)}
                className="p-2 border rounded-lg min-w-[160px]"
              >
                {projects.map((p) => (
                  <option key={p}>{p}</option>
                ))}
              </select>
              <button
  onClick={requestNotifyPermission}
  className={`px-3 py-2 rounded-lg text-sm ${darkMode ? "bg-gray-700 text-indigo-200" : "bg-white border text-indigo-600"}`}
>
  ğŸ”” íˆ¬ë‘ì•Œë¦¼ on
</button>


              {/* ì˜¤ë¥¸ìª½ ë: ë¼ì´íŠ¸/ë‹¤í¬ëª¨ë“œ ë²„íŠ¼ */}
              <button
                onClick={() => setDarkMode(!darkMode)}
                className={`ml-auto px-3 py-2 rounded-lg transition ${
                  darkMode
                    ? "bg-gray-700 hover:bg-gray-600 text-yellow-300"
                    : "bg-white hover:bg-gray-100 text-gray-700 border"
                }`}
              >
                {darkMode ? "â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ" : "ğŸŒ™ ë‹¤í¬ëª¨ë“œ"}
              </button>
            </div>
            

            {/* 2ì¤„ì°¨: ì‘í’ˆ ì¶”ê°€/ì‚­ì œ ê´€ë¦¬ */}
            <div className="flex items-center gap-2 text-sm">
              <input
                type="text"
                placeholder="ìƒˆ ì‘í’ˆëª… ì…ë ¥"
                value={newProjectName}
                onChange={(e) => setNewProjectName(e.target.value)}
                className="flex-1 p-2 border rounded-lg"
              />
              <button
                onClick={() => {
                  const name = newProjectName.trim();
                  if (!name) return alert("ì‘í’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                  if (projects.includes(name)) return alert("ì´ë¯¸ ìˆëŠ” ì‘í’ˆëª…ì…ë‹ˆë‹¤.");
                  const updated = [...projects, name];
                  setProjects(updated);
                  setNewProjectName("");
                  if (!filterProject) setFilterProject(name);
                }}
                className="px-3 py-2 bg-indigo-500 text-white rounded-lg"
              >
                + ì‘í’ˆ ì¶”ê°€
              </button>
              {filterProject && (
                <button
                  onClick={() => {
                    if (!confirm(`'${filterProject}' ì‘í’ˆì„ ëª©ë¡ì—ì„œ ì‚­ì œí• ê¹Œìš”?\n(ê¸°ì¡´ ì§‘í•„ ê¸°ë¡ì€ ë‚¨ì•„ ìˆì§€ë§Œ, ìƒˆë¡œ ì„ íƒì€ í•  ìˆ˜ ì—†ì–´ìš”.)`))
                      return;
                    const updated = projects.filter((p) => p !== filterProject);
                    setProjects(updated);
                    if (updated.length > 0) {
                      setFilterProject(updated[0]);
                    } else {
                      setFilterProject("");
                    }
                  }}
                  className="px-3 py-2 text-rose-500 border border-rose-300 rounded-lg"
                >
                  ì„ íƒ ì‘í’ˆ ì‚­ì œ
                </button>
              )}
              {filterProject && (
  <button
  onClick={() => renameProject(filterProject)}
  className="px-3 py-2 text-blue-500 border border-blue-300 rounded-lg"
>
  âœï¸ ì‘í’ˆëª… ë³€ê²½
</button>
)}

            </div>
          </div>


          {/* ğŸŒ… ì‘í’ˆë³„ ì‹œì‘ ì •ë³´ */}
          <div className={`${darkMode ? "bg-gray-850 text-gray-200 border border-gray-700" : "bg-indigo-50 text-gray-900 border border-gray-200"} p-4 rounded-lg mb-4`}>

            <h3 className="font-semibold mb-2 text-indigo-700">
              ğŸŒ… {filterProject} ì‹œì‘ ì •ë³´
            </h3>

            <div className="flex gap-4 mb-2 items-center">
              <label className="text-sm w-24">ì‹œì‘ ì‹œê°„</label>
              <input
                type="time"
                value={projectData.startTime || ""}
                onChange={(e) =>
                  setProjectData((cur) => ({
                    ...cur,
                    startTime: e.target.value,
                  }))
                }
                className="p-2 border rounded-lg w-40"
              />
            </div>

            <div className="flex gap-4 items-center">
              <label className="text-sm w-24">ì‹œì‘ ê¸€ììˆ˜</label>
              <input
                type="number"
                value={projectData.startWords || ""}
                onChange={(e) =>
                  setProjectData((cur) => ({
                    ...cur,
                    startWords: Number(e.target.value) || 0,
                  }))
                }
                className="p-2 border rounded-lg w-40"
              />
            </div>
          </div>

          {/* ğŸ”¥ ì˜¤ëŠ˜ì˜ ì§‘í•„ ë­í‚¹ & ëª©í‘œ ë‹¬ì„±ë¥  */}
          <div className={`${darkMode
            ? "bg-gray-850 text-gray-200 border-gray-700"
            : "bg-white text-gray-900 border-gray-200"} p-4 rounded-lg`}>

            <h2 className="font-semibold text-lg mb-4">ğŸ”¥ ì˜¤ëŠ˜ì˜ ì§‘í•„ ë­í‚¹ & ëª©í‘œ ë‹¬ì„±ë¥ </h2>

            {(() => {
              const today = store[dateStr] || {};
const entries = Object.entries(today).filter(
  ([k, v]) => k !== "dailySummary" && v && Array.isArray(v.logs)
);


              if (entries.length === 0) {
                return <p className="text-gray-500 text-sm">ì˜¤ëŠ˜ ì‘ì„±ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>;
              }

              const projectRank = entries
                .map(([proj, val]) => {
                  const total = (val.logs || []).reduce((s, l) => s + (l.diff || 0), 0);
                  const goal = val.goal || 4000; // ê¸°ë³¸ ëª©í‘œ 4ì²œì
                  const progress = Math.min(100, (total / goal) * 100);
                  return { proj, total, goal, progress };
                })
                .sort((a, b) => b.total - a.total);

              return (
                <div className="space-y-3">
                  {projectRank.map((p, idx) => (
                    <div key={p.proj} className={`p-3 border rounded-lg ${darkMode ? "bg-gray-850 text-gray-200 border-gray-700" : "bg-gray-50 text-gray-900 border-gray-200"
                      }`}>

                      <div className="flex justify-between items-center mb-2">
                        <div className="flex items-center gap-2">
                          <span className="font-medium text-indigo-700">{p.proj}</span>
                          {idx === 0 && <span className="text-red-500 text-lg">ğŸ”¥</span>}
                        </div>
                        <span className="text-sm text-gray-600">{p.total.toLocaleString()}ì</span>
                      </div>

                      {/* ì§„í–‰ë¥  ë°” */}
                      <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div
                          className={`h-3 rounded-full ${p.progress >= 100 ? "bg-green-500" : "bg-indigo-500"
                            }`}
                          style={{ width: `${p.progress}%` }}
                        ></div>
                      </div>

                      {/* ëª©í‘œëŸ‰ ë° ë‹¬ì„±ë¥  í‘œì‹œ */}
                      <div className="flex justify-between text-xs text-gray-500 mt-1">
                        <span>ëª©í‘œ: {p.goal.toLocaleString()}ì</span>
                        <span>
                          ë‹¬ì„±ë¥ : {p.progress.toFixed(1)}%
                          <span className="ml-2">
                            (ë‚¨ì€ {Math.max(0, p.goal - p.total).toLocaleString()}ì)
                          </span>
                        </span>
                      </div>

                      {/* ëª©í‘œëŸ‰ ë³€ê²½ + ì‚­ì œ */}
                      <div className="flex gap-2 mt-2 items-center">
                        <input
                          type="number"
                          placeholder="ëª©í‘œëŸ‰ ìˆ˜ì •"
                          value={p.goal} // âœ… defaultValue â†’ value ë¡œ ë³€ê²½
                          onChange={(e) => {
                            const newGoal = Number(e.target.value || 0);
                            setDay((cur) => {
                              const n = JSON.parse(JSON.stringify(cur ?? emptyDay()));
                              if (!n[p.proj]) n[p.proj] = { logs: [] };
                              n[p.proj].goal = newGoal;
                              return n;
                            });
                          }}
                          className="w-24 p-1 text-sm border rounded"
                        />

                        <button
                          onClick={() => {
                            if (confirm(`${p.proj}ì„(ë¥¼) ì˜¤ëŠ˜ì˜ ëª©ë¡ì—ì„œ ì‚­ì œí• ê¹Œìš”?`)) {
                              setDay((cur) => {
                                const n = JSON.parse(JSON.stringify(cur ?? emptyDay()));
                                delete n[p.proj];
                                // âœ… localStorage ì¦‰ì‹œ ë°˜ì˜
                                const updatedStore = {
                                  ...store,
                                  [dateStr]: n
                                };
                                localStorage.setItem("writer_planner_store_v4", JSON.stringify(updatedStore));
                                setStore(updatedStore); // ìƒíƒœ ê°±ì‹ 
                                return n;
                              });
                            }
                          }}
                          className="text-xs text-rose-400 hover:text-rose-300 border border-rose-300/30 px-2 py-[2px] rounded transition"
                        >
                          ì‘í’ˆ ì‚­ì œ
                        </button>

                      </div>

                    </div>
                  ))}
                </div>
              );
            })()}
          </div>

          {/* ğŸ§± ë¡œê·¸ ì…ë ¥ */}
          {/* ğŸ§± ë¡œê·¸ ì…ë ¥ + ì˜¤ëŠ˜ ì´í•© í‘œì‹œ */}
          <div
            id="log-section"
            className="flex items-center gap-3 mb-4"
          >

            <div className="flex gap-2 flex-grow">
              <input
                id="currentWords"
                type="number"
                placeholder="í˜„ì¬ ê¸€ììˆ˜"
                className="p-2 border rounded-lg w-32"
              />
              <button
                onClick={() => {
                  const cur = Number(
                    document.getElementById("currentWords").value || 0
                  );
                  if (cur <= 0) return alert("í˜„ì¬ ê¸€ììˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
                  addLog(cur);
                  document.getElementById("currentWords").value = "";
                }}
                className="px-4 py-2 bg-indigo-500 text-white rounded-lg"
              >
                + ê¸°ë¡
              </button>
            </div>

          </div>


          {/* ğŸ§© ë¡œê·¸ ëª©ë¡ (ì ‘ê¸°/í¼ì¹˜ê¸° í† ê¸€) */}
          <div className="mb-3">
            <button
              onClick={() => setShowLogs(!showLogs)}
              className={`text-sm mb-2 px-3 py-1 rounded-md border ${darkMode
                  ? "border-gray-600 text-indigo-300 hover:bg-gray-800"
                  : "border-gray-300 text-indigo-600 hover:bg-indigo-50"
                }`}
            >
              {showLogs ? "â–¼ ë¡œê·¸ ì ‘ê¸°" : "â–¶ ë¡œê·¸ ì—´ê¸°"}{" "}
              ({(projectData.logs ?? []).length}ê°œ)
            </button>

            {showLogs &&
              ((projectData.logs ?? []).length === 0 ? (
                <div className="text-gray-500 text-sm">ë¹¨ë¦¬ ì‘ì—…ì„ ì‹œì‘í•˜ì</div>
              ) : (
                [...(projectData.logs ?? [])]
                  .sort((a, b) => parseKoreanTime(b.time) - parseKoreanTime(a.time))
                  .map((l, i) => (
                    <div
                      key={i}
                      className={`flex justify-between items-center p-2 mb-1 rounded-lg ${darkMode
                          ? "bg-gray-800 text-gray-200 border border-gray-700"
                          : "bg-gray-50 text-gray-900 border border-gray-200"
                        }`}
                    >
                      <span>{l.time}</span>
                      <span>{l.diff.toLocaleString()}ì</span>
                      <button
                        onClick={() => {
                          const originalIndex = projectData.logs.findIndex(
                            (x) => x.time === l.time && x.currentWords === l.currentWords
                          );
                          removeLog(originalIndex);
                        }}

                        className="text-xs text-red-500"
                      >
                        ì‚­ì œ
                      </button>
                    </div>
                  ))
              ))}
          </div>

         {/* ğŸ“Š ì‘í’ˆë³„ ìš”ì•½ í†µê³„ */}
<div
  className={`${darkMode
    ? "bg-gray-850 text-gray-200 border-gray-700"
    : "bg-white text-gray-900 border-gray-200"} p-4 rounded-lg`}
>
  <h2 className="font-semibold text-lg mb-4">
    ğŸ“Š ì˜¤ëŠ˜ì˜ ì‘í’ˆë³„ ìš”ì•½
  </h2>
{/* ğŸ“ ì˜¤ëŠ˜ ì‘ì—… í•œ ì¤„ ìš”ì•½ */}
<div className={`mb-4 p-3 rounded-lg ${
  darkMode
    ? "bg-gray-800 border border-gray-700"
    : "bg-gray-50 border border-gray-200"
}`}>
  {(() => {
    const rawSummary = store[dateStr]?.dailySummary;
    const summaryValue =
      typeof rawSummary === "string"
        ? rawSummary
        : (rawSummary?.text ?? "");

    return (
      <input
        type="text"
        value={summaryValue}
        onChange={(e) => {
          const value = e.target.value;
          setStore((prev) => ({
            ...prev,
            [dateStr]: {
              ...prev[dateStr],
              dailySummary: value, // âœ… ë¬´ì¡°ê±´ string
            },
          }));
        }}
        placeholder="ì˜¤ëŠ˜ì€ ì–´ë–¤ ì‘ì—…ì„ í–ˆì–´?"
        className="w-full text-sm px-3 py-2 rounded
                   bg-white dark:bg-gray-700
                   border border-gray-300 dark:border-gray-600
                   text-gray-800 dark:text-gray-100"
      />
    );
  })()}
</div>

  {(() => {
    const today = store[dateStr] || {};

const projectSummaries = Object.entries(today)
  .filter(([key, data]) => key !== "dailySummary" && data && Array.isArray(data.logs))
  .map(([proj, data]) => {
    const logs = data.logs;
    const total = logs.reduce((sum, l) => sum + (l.diff || 0), 0);
    const sessions = logs.length;
    const avg = sessions > 0 ? Math.round(total / sessions) : 0;

    return { proj, total, sessions, avg };
  });


    const grandTotal = projectSummaries.reduce(
      (s, p) => s + p.total,
      0
    );

    if (projectSummaries.length === 0) {
      return (
        <p className="text-gray-500 text-sm">
          ì˜¤ëŠ˜ ê¸°ë¡ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.
        </p>
      );
    }

    return (
      <>
        {/* ì „ì²´ ì´í•© */}
        <div
          className={`flex justify-between items-center mb-4 p-3 rounded-lg ${
            darkMode
              ? "bg-gray-800 text-gray-200 border border-gray-700"
              : "bg-indigo-50 text-gray-900 border border-gray-200"
          }`}
        >
          <span className="font-semibold text-indigo-700">
            ì „ì²´ í•©ê³„
          </span>
          <span className="font-bold text-indigo-600 text-lg">
            {grandTotal.toLocaleString()}ì
          </span>
        </div>

        {/* ì‘í’ˆë³„ í‘œ */}
        <table className="w-full border-collapse mb-6 text-sm">
          <thead>
            <tr
              className={`text-left ${
                darkMode
                  ? "bg-gray-900 text-indigo-300 border-b border-gray-700"
                  : "bg-gray-100 text-indigo-600 border-b border-gray-300"
              }`}
            >
              <th className="px-4 py-2">ì‘í’ˆëª…</th>
              <th className="px-4 py-2">ì„¸ì…˜ ìˆ˜</th>
              <th className="px-4 py-2">ì´í•©</th>
              <th className="px-4 py-2">í‰ê· </th>
            </tr>
          </thead>

          <tbody>
            {projectSummaries.map((p) => (
              <tr key={p.proj}>
                {/* ì‘í’ˆëª… + í•œ ì¤„ ìš”ì•½ */}
                <td className="border p-2 align-top">
                  <div className="text-indigo-600 font-medium">
                    {p.proj}
                  </div>
               </td>

                <td className="border p-2 text-center">
                  {p.sessions}
                </td>

                <td className="border p-2 text-center text-indigo-700">
                  {p.total.toLocaleString()}ì
                </td>

                <td className="border p-2 text-center text-gray-700">
                  {p.avg.toLocaleString()}ì
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {/* ê·¸ë˜í”„ */}
        <h3 className="font-semibold mb-2 text-gray-700">
          ğŸ“ˆ ì‹œê°í™”
        </h3>

        <div
          className={`graph-area flex items-end gap-2 h-48 p-4 rounded-lg overflow-x-auto ${
            darkMode ? "text-gray-200" : "text-gray-900"
          }`}
        >
          {projectSummaries.map((p) => {
            const maxValue = Math.max(
              ...projectSummaries.map((x) => x.total),
              1
            );
            const height = (p.total / maxValue) * 160;

            return (
              <div
                key={p.proj}
                className="flex flex-col items-center justify-end flex-1"
              >
                <div
                  className="bg-indigo-500 rounded-t w-6"
                  style={{ height: `${height}px` }}
                />
                <span className="text-xs mt-2 text-center break-keep">
                  {p.proj}
                </span>
              </div>
            );
          })}
        </div>
      </>
    );
  })()}
</div>
          {/* ğŸ“… ì›”ê°„ / ì—°ê°„ ëˆ„ì  í†µê³„ */}
          <div id="monthly-section"
            className={`${darkMode
              ? "bg-gray-850 text-gray-200 border-gray-700"
              : "bg-white text-gray-900 border-gray-200"} p-4 rounded-lg`}
          >

            <h2 className="font-semibold text-lg mb-4">ğŸ“… ì›”ê°„ Â· ì—°ê°„ ëˆ„ì  í†µê³„</h2>

            {(() => {
              const now = new Date(dateStr);
              const year = now.getFullYear();
              const month = now.getMonth();

              // ì›”ê°„ ëˆ„ì 
              const monthlyTotals = {};
              Object.entries(store).forEach(([day, data]) => {
                const d = new Date(day);
                if (d.getFullYear() === year && d.getMonth() === month) {
                  Object.entries(data || {}).forEach(([proj, val]) => {
                    if (!val.logs) return;
                    const total = val.logs.reduce((s, l) => s + (l.diff || 0), 0);
                    monthlyTotals[proj] = (monthlyTotals[proj] || 0) + total;
                  });
                }
              });

              // ì—°ê°„ ëˆ„ì 
              const yearlyTotals = {};
              Object.entries(store).forEach(([day, data]) => {
                const d = new Date(day);
                if (d.getFullYear() === year) {
                  Object.entries(data || {}).forEach(([proj, val]) => {
                    if (!val.logs) return;
                    const total = val.logs.reduce((s, l) => s + (l.diff || 0), 0);
                    yearlyTotals[proj] = (yearlyTotals[proj] || 0) + total;
                  });
                }
              });

              const monthlySorted = Object.entries(monthlyTotals).sort((a, b) => b[1] - a[1]);
              const yearlySorted = Object.entries(yearlyTotals).sort((a, b) => b[1] - a[1]);

              const maxMonth = Math.max(...monthlySorted.map(([_, v]) => v), 1);
              const maxYear = Math.max(...yearlySorted.map(([_, v]) => v), 1);

              return (
                <>
                  {/* ì›”ê°„ ìš”ì•½ */}
                  <div className="mb-8">
                    <h3 className="font-semibold mb-2 text-indigo-700">ğŸ“† ì´ë²ˆ ë‹¬ ëˆ„ì </h3>
                    {monthlySorted.length === 0 ? (
                      <p className="text-gray-500 text-sm">ì´ë²ˆ ë‹¬ ì‘ì„± ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    ) : (
                      <>
                        <ul className="text-sm mb-4">
                          {monthlySorted.map(([proj, val]) => (
                            <li key={proj} className="flex justify-between border-b py-1">
                              <span className="text-indigo-600">{proj}</span>
                              <span>{val.toLocaleString()}ì</span>
                            </li>
                          ))}
                        </ul>
                        <div className={`flex items-end gap-2 h-40 p-3 rounded-lg overflow-x-auto ${darkMode ? "bg-gray-800 text-gray-200" : "bg-gray-50 text-gray-900"
                          }`}>

                          {monthlySorted.map(([proj, val]) => (
                            <div key={proj} className="flex flex-col items-center justify-end flex-1">
                              <div
                                className="bg-indigo-400 rounded-t w-6"
                                style={{ height: `${(val / maxMonth) * 150}px` }}
                              ></div>
                              <span className="text-xs mt-2 text-center break-keep">{proj}</span>
                            </div>
                          ))}
                        </div>
                      </>
                    )}
                  </div>

                  {/* ì—°ê°„ ìš”ì•½ */}
                  <div>
                    <h3 className="font-semibold mb-2 text-indigo-700">ğŸ“˜ ì˜¬í•´ ëˆ„ì </h3>
                    {yearlySorted.length === 0 ? (
                      <p className="text-gray-500 text-sm">ì˜¬í•´ ì‘ì„± ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    ) : (
                      <>
                        <ul className="text-sm mb-4">
                          {yearlySorted.map(([proj, val]) => (
                            <li key={proj} className="flex justify-between border-b py-1">
                              <span className="text-indigo-600">{proj}</span>
                              <span>{val.toLocaleString()}ì</span>
                            </li>
                          ))}
                        </ul>
                        <div className="graph-area flex items-end gap-2 h-48 p-3 rounded-lg overflow-x-auto">
                          {yearlySorted.map(([proj, val]) => (
                            <div key={proj} className="flex flex-col items-center justify-end flex-1">
                              <div
                                className="bg-indigo-500 rounded-t w-6"
                                style={{ height: `${(val / maxYear) * 160}px` }}
                              ></div>
                              <span className="text-xs mt-2 text-center break-keep">{proj}</span>
                            </div>
                          ))}
                        </div>
                      </>
                    )}
                  </div>
                </>
              );
            })()}
          </div>
{/* ğŸ—“ ì›”ê°„ ì§‘í•„ í†µê³„ (ì—°ê°„ íë¦„) */}
<div
  className={`${darkMode
    ? "bg-gray-850 text-gray-200 border-gray-700"
    : "bg-white text-gray-900 border-gray-200"} p-4 rounded-lg mt-6`}
>
  <h2 className="font-semibold text-lg mb-4">ğŸ—“ ì›”ê°„ ì§‘í•„ í†µê³„</h2>
  {(() => {
    const monthlyTotals = {};

    // ì „ì²´ store ìˆœíšŒí•´ì„œ ì›” ë‹¨ìœ„ë¡œ ì´í•© ê³„ì‚°
    Object.entries(store).forEach(([date, data]) => {
      const d = new Date(date);
      const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
      let total = 0;
      Object.values(data).forEach((proj) => {
        if (!proj?.logs) return;
        total += proj.logs.reduce((s, l) => s + (l.diff || 0), 0);
      });
      monthlyTotals[ym] = (monthlyTotals[ym] || 0) + total;
    });

    const entries = Object.entries(monthlyTotals).sort(([a], [b]) => a.localeCompare(b));
    const maxVal = Math.max(...entries.map(([_, v]) => v), 1);

    if (entries.length === 0)
      return <p className="text-sm text-gray-500">ì•„ì§ ì›”ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>;

    // í‰ê·  ê³„ì‚°
    const avg = Math.round(entries.reduce((a, [, v]) => a + v, 0) / entries.length);

    return (
      <div>
        <div className="text-sm text-gray-600 mb-3">
          ğŸ“ˆ ì›”í‰ê·  {avg.toLocaleString()}ì / ìµœê³ {" "}
          {Math.max(...entries.map(([_, v]) => v)).toLocaleString()}ì
        </div>

        <div className="flex items-end gap-2 h-48 p-3 rounded-lg overflow-x-auto">
          {entries.map(([month, total]) => (
            <div
              key={month}
              className="flex flex-col items-center justify-end flex-1 min-w-[36px]"
            >
              <div
                className="bg-indigo-500 rounded-t w-6"
                style={{ height: `${(total / maxVal) * 160}px` }}
              ></div>
              <span className="text-[11px] mt-1">{month}</span>
              <span className="text-[10px] text-gray-500">{total.toLocaleString()}ì</span>
            </div>
          ))}
        </div>
      </div>
    );
  })()}
</div>

          {/* ğŸ“˜ ì—°ë„ë³„ ì‘ì—… í†µê³„ */}
<div
  className={`${darkMode
    ? "bg-gray-850 text-gray-200 border-gray-700"
    : "bg-white text-gray-900 border-gray-200"} p-4 rounded-lg mt-6`}
>
  <h2 className="font-semibold text-lg mb-4">ğŸ“˜ ì—°ê°„ ì§‘í•„ í†µê³„</h2>
  {(() => {
    const yearlyTotals = {};
    Object.entries(store).forEach(([date, data]) => {
      const y = new Date(date).getFullYear();
      let dayTotal = 0;
      Object.values(data).forEach((proj) => {
        if (proj?.logs) dayTotal += proj.logs.reduce((s, l) => s + (l.diff || 0), 0);
      });
      yearlyTotals[y] = (yearlyTotals[y] || 0) + dayTotal;
    });

    const entries = Object.entries(yearlyTotals).sort(([a], [b]) => a - b);
    const maxVal = Math.max(...entries.map(([_, v]) => v), 1);

    if (entries.length === 0)
      return <p className="text-sm text-gray-500">ì•„ì§ ê¸°ë¡ëœ ì—°ê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>;

    return (
      <div className="flex items-end gap-3 h-48 p-3 rounded-lg overflow-x-auto">
        {entries.map(([year, total]) => (
          <div key={year} className="flex flex-col items-center justify-end flex-1">
            <div
              className="bg-indigo-500 rounded-t w-8"
              style={{ height: `${(total / maxVal) * 160}px` }}
            ></div>
            <span className="text-xs mt-1">{year}</span>
            <span className="text-[10px] text-gray-500">{total.toLocaleString()}ì</span>
          </div>
        ))}
      </div>
    );
  })()}
</div>


          {/* ğŸ¯ ì‘í’ˆë³„ ëª©í‘œ ëŒ€ë¹„ ì§„í–‰ë¥  */}
          <div id="project-progress-section" className={`${darkMode
            ? "bg-gray-850 text-gray-200 border-gray-700"
            : "bg-white text-gray-900 border-gray-200"} p-4 rounded-lg`}>



            <h2 className="font-semibold text-lg mb-4">ğŸ¯ ì‘í’ˆë³„ ëª©í‘œ ì§„í–‰ë¥ </h2>

            {(() => {
              // ëª©í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
              const raw = localStorage.getItem("writer_targets");
              const targets = raw ? JSON.parse(raw) : {};

              // ëª©í‘œ ìˆ˜ì •
const updateTarget = (proj, val) => {
  const updated = { ...targets, [proj]: val };
  localStorage.setItem("writer_targets", JSON.stringify(updated));
  alert(`${proj} ëª©í‘œê°€ ${val.toLocaleString()}ìë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);

  // âœ… ì¦‰ì‹œ ë¦¬ë Œë”ë§ ë°˜ì˜
  forceRender((n) => n + 1);
};


              // ê° ì‘í’ˆë³„ ì´í•©
              const projectTotals = {};

Object.entries(store).forEach(([_, data]) => {
  Object.entries(data || {}).forEach(([proj, val]) => {
    // âœ… ì‘í’ˆ ëª©ë¡ì— ì—†ëŠ” í‚¤ëŠ” ì „ë¶€ ì œì™¸
    if (proj === "dailySummary") return;
    if (!projects.includes(proj)) return;
    if (!val.logs) return;

    const total = val.logs.reduce((s, l) => s + (l.diff || 0), 0);
    projectTotals[proj] = (projectTotals[proj] || 0) + total;
  });
});


              const entries = Object.entries(projectTotals).sort((a, b) => b[1] - a[1]);
              const visibleEntries = entries.filter(([proj, total]) => {
  const goal = targets[proj] || 0;
  if (goal <= 0) return true;            // ëª©í‘œ ë¯¸ì„¤ì •ì€ ë³´ì—¬ì¤Œ
  return total < goal;                    // ëª©í‘œ ë‹¬ì„±(=100% ì´ìƒ)ì€ ìˆ¨ê¹€
});


              if (entries.length === 0) {
                return <p className="text-gray-500 text-sm">ê¸°ë¡ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>;
              }

              return (
                <div className="space-y-4">
                  {visibleEntries.map(([proj, total]) => {
                    const goal = targets[proj] || 0;
                    const progress = goal > 0 ? Math.min(100, (total / goal) * 100) : 0;
                    const barColor =
                      progress >= 100
                        ? "bg-green-500"
                        : progress >= 70
                          ? "bg-indigo-500"
                          : "bg-gray-300";

                    return (
                      <div key={proj} className="p-3 border rounded-lg">
                        <div className="flex justify-between items-center mb-2">
                          <span className="font-medium text-indigo-700">{proj}</span>
                          <span className="text-sm text-gray-600">
                            {goal > 0 ? `${progress.toFixed(1)}%` : "ëª©í‘œ ë¯¸ì„¤ì •"}
                          </span>
                        </div>

                        {/* ì§„í–‰ë¥  ë°” */}
                        <div className="w-full bg-gray-200 h-3 rounded-full overflow-hidden mb-2">
                          <div
                            className={`${barColor} h-3 transition-all duration-300`}
                            style={{ width: `${progress}%` }}
                          ></div>
                        </div>

                        {/* ëª©í‘œ ì…ë ¥ */}
                        <div className="flex items-center gap-2">
                          <input
                            type="number"
                            placeholder="ëª©í‘œ ê¸€ììˆ˜"
                            defaultValue={goal || ""}
                            className="p-1 border rounded-lg w-32 text-sm"
                            id={`goal-${proj}`}
                          />
                          <button
                            className="px-3 py-1 text-xs bg-indigo-500 text-white rounded-lg"
                            onClick={() => {
                              const val = Number(document.getElementById(`goal-${proj}`).value || 0);
                              updateTarget(proj, val);
                            }}
                          >
                            ì €ì¥
                          </button>
                        </div>

      

  {/* í˜„ì¬ ì´í•© ë° ë‚¨ì€ ë¶„ëŸ‰ */}
<div className="text-xs text-gray-500 mt-1">
  í˜„ì¬ {total.toLocaleString()}ì / ëª©í‘œ{" "}
  {goal > 0 ? goal.toLocaleString() : "ë¯¸ì„¤ì •"} / ì•ìœ¼ë¡œ{" "}
  {goal > 0 ? Math.max(0, goal - total).toLocaleString() : "-"}ì
</div>

                      </div>
                    );
                  })}
                </div>
              );
            })()}
          </div>

<GoalTimelineSection darkMode={darkMode} />

  


          {/* ğŸ“… ì£¼ê°„ & ì›”ê°„ íŠ¸ë Œë“œ ëŒ€ì‹œë³´ë“œ */}
          <div className={`${darkMode
            ? "bg-gray-850 text-gray-200 border-gray-700"
            : "bg-white text-gray-900 border-gray-200"} p-4 rounded-lg`}>



            <h2 className="font-semibold text-lg mb-4">ğŸ“… ì£¼ê°„ & ì›”ê°„ íŠ¸ë Œë“œ</h2>

            {(() => {
              const today = new Date(dateStr);
              const past7Days = [];
              for (let i = 6; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const key = fmtDate(d);
                const data = store[key] || {};
                let total = 0;
                Object.values(data).forEach((proj) => {
                  if (proj?.logs) total += proj.logs.reduce((s, l) => s + (l.diff || 0), 0);
                });
                past7Days.push({ date: key, total });
              }

              const maxWeekly = Math.max(...past7Days.map((d) => d.total), 1);
              const avgWeekly = past7Days.reduce((a, b) => a + b.total, 0) / 7;

              // ğŸ—“ ì›”ê°„ ë°ì´í„° ê³„ì‚°
              const currentYear = today.getFullYear();
              const currentMonth = today.getMonth();
              const monthData = {};

              Object.entries(store).forEach(([key, val]) => {
                const d = new Date(key);
                if (d.getFullYear() === currentYear && d.getMonth() === currentMonth) {
                  const week = Math.ceil(d.getDate() / 7); // 1~4ì£¼ì°¨ ë¶„ë¥˜
                  let total = 0;
                  Object.values(val).forEach((proj) => {
                    if (proj?.logs) total += proj.logs.reduce((s, l) => s + (l.diff || 0), 0);
                  });
                  monthData[week] = (monthData[week] || 0) + total;
                }
              });

              const monthWeeks = Object.keys(monthData).sort();
              const maxMonthly = Math.max(...Object.values(monthData), 1);

              return (
                <div className="space-y-8">

                  {/* ğŸ“† ì£¼ê°„ íŠ¸ë Œë“œ */}
                  <section>
                    <h3 className="font-semibold text-md mb-2 text-indigo-700">ğŸ“† ìµœê·¼ 7ì¼ê°„ ì§‘í•„ ì¶”ì´</h3>
                    <div className={`flex items-end gap-2 h-40 rounded-lg p-2 overflow-x-auto ${darkMode ? "bg-gray-800 text-gray-200" : "bg-gray-50 text-gray-900"
                      }`}>

                      {past7Days.map((d, i) => (
                        <div key={i} className="flex flex-col items-center justify-end flex-1 min-w-[28px]">
                          <div
                            className="bg-indigo-400 rounded-t"
                            style={{ height: `${(d.total / maxWeekly) * 120}px`, width: "18px" }}
                          ></div>
                          <span className="text-[10px] text-gray-500 mt-1">
                            {d.date.slice(5)}
                          </span>
                        </div>
                      ))}
                    </div>
                    <div className="text-sm text-gray-600 mt-3">
                      ğŸ“ˆ ì¼í‰ê· : <b>{Math.round(avgWeekly).toLocaleString()}ì</b>,
                      ìµœê³ : <b>{Math.max(...past7Days.map((d) => d.total)).toLocaleString()}ì</b>
                    </div>
                  </section>

                  {/* ğŸ—“ ì›”ê°„ íŠ¸ë Œë“œ */}
                  <section>
                    <h3 className="font-semibold text-md mb-2 text-indigo-700">ğŸ—“ ì´ë²ˆ ë‹¬ ì£¼ì°¨ë³„ í‰ê· </h3>
                    <div className={`graph-area flex items-end gap-2 h-48 p-4 rounded-lg overflow-x-auto ${darkMode ? "text-gray-200" : "text-gray-900"
                      }`}>

                      {monthWeeks.length === 0 && (
                        <p className="text-gray-500 text-sm m-auto">ì´ë²ˆ ë‹¬ ì‘ì„± ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                      )}
                      {monthWeeks.map((w) => (
                        <div key={w} className="flex flex-col items-center justify-end flex-1">
                          <div
                            className="bg-indigo-500 rounded-t"
                            style={{ height: `${(monthData[w] / maxMonthly) * 160}px`, width: "28px" }}
                          ></div>
                          <span className="text-xs text-gray-500 mt-1">{w}ì£¼ì°¨</span>
                        </div>
                      ))}
                    </div>
                  </section>

                </div>
              );
            })()}
          </div>
          {/* ğŸ—“ ì›”ê°„ ì§‘í•„ ìº˜ë¦°ë” */}
          <div
            id="calendar-section"
            className={`${darkMode
              ? "bg-gray-850 text-gray-200 border-gray-700"
              : "bg-white text-gray-900 border-gray-200"} p-4 rounded-lg`}>

            <h2 className="font-semibold text-lg mb-4">ğŸ—“ ì›”ê°„ ì§‘í•„ ìº˜ë¦°ë”</h2>

            {(() => {
              const today = new Date(dateStr);
              const year = today.getFullYear();
              const month = today.getMonth(); // 0~11

              // ì›” ì²«ì§¸ ë‚  ìš”ì¼ ê³„ì‚°
              const firstDay = new Date(year, month, 1).getDay();
              const daysInMonth = new Date(year, month + 1, 0).getDate();

              // ğŸ§® ì¼ìë³„ ì´í•© ê³„ì‚°
              const monthData = {};
              Object.entries(store).forEach(([date, data]) => {
                const d = new Date(date);
                if (d.getFullYear() === year && d.getMonth() === month) {
                  const total = Object.values(data || {}).reduce((sum, proj) => {
                    if (!proj?.logs) return sum;
                    return sum + proj.logs.reduce((s, l) => s + (l.diff || 0), 0);
                  }, 0);
                  monthData[d.getDate()] = total;
                }
              });

              // ğŸ¨ ìƒ‰ìƒ ê²°ì • í•¨ìˆ˜
              const getColor = (value) => {
                if (!value || value === 0) return "bg-gray-100 text-gray-400";
                if (value < 3000) return "bg-indigo-100 text-gray-700";
                if (value < 6000) return "bg-indigo-300 text-white";
                if (value < 9000) return "bg-green-300 text-white";
                return "bg-green-500 text-white";
              };

              // ğŸ“Š ì›”ê°„ ìš”ì•½ í†µê³„
              const total = Object.values(monthData).reduce((a, b) => a + b, 0);
              const daysWritten = Object.values(monthData).filter((v) => v > 0).length;
              const avg = daysWritten > 0 ? Math.round(total / daysWritten) : 0;
              const goal = 150000;
              const progress = Math.min(100, (total / goal) * 100);

              return (
                <div>
                  {/* ì›” ë³€ê²½ ë„¤ë¹„ê²Œì´ì…˜ */}
                  <div className="flex justify-between items-center mb-4">
                    <button
                      onClick={() => {
                        const prev = new Date(year, month - 1, 1);
                        setDateStr(fmtDate(prev));
                      }}
                      className="px-3 py-1 bg-gray-200 rounded-lg"
                    >
                      â—€ ì´ì „ ë‹¬
                    </button>

                    <h3 className="text-lg font-semibold text-indigo-700">
                      {year}ë…„ {month + 1}ì›”
                    </h3>

                    <button
                      onClick={() => {
                        const next = new Date(year, month + 1, 1);
                        setDateStr(fmtDate(next));
                      }}
                      className="px-3 py-1 bg-gray-200 rounded-lg"
                    >
                      ë‹¤ìŒ ë‹¬ â–¶
                    </button>
                  </div>

                  {/* ğŸ§± ìº˜ë¦°ë” */}
                  <div className="grid grid-cols-7 text-center text-sm font-medium mb-2 text-gray-600">
                    <div>ì¼</div>
                    <div>ì›”</div>
                    <div>í™”</div>
                    <div>ìˆ˜</div>
                    <div>ëª©</div>
                    <div>ê¸ˆ</div>
                    <div>í† </div>
                  </div>

                  <div className="grid grid-cols-7 gap-2 text-center text-xs">
                    {/* ê³µë°± ì±„ìš°ê¸° */}
                    {Array.from({ length: firstDay }).map((_, i) => (
                      <div key={`empty-${i}`} className="h-20"></div>
                    ))}

                    {/* ë‚ ì§œë³„ ì…€ */}
                    {Array.from({ length: daysInMonth }).map((_, i) => {
                      const day = i + 1;
                      const value = monthData[day] || 0;
                      const color = getColor(value);
                      const key = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

                      const tasksByDate = JSON.parse(localStorage.getItem("calendar_tasks") || "{}");

const dayTasks = normalizeTasks((calendarTasks && calendarTasks[key]) || []);



                      return (
                        <div
                          key={day}
                          onClick={() => {
  setTodoModalDate(key);      // YYYY-MM-DD
  setTodoModalOpen(true);
}}

                          className={`calendar-day flex flex-col justify-between h-20 rounded-lg p-1 shadow-sm cursor-pointer hover:ring-2 hover:ring-indigo-400 transition ${darkMode
                              ? `${value > 0
                                ? "bg-gradient-to-b from-indigo-700 to-indigo-900 border border-indigo-600 text-white"
                                : "bg-gray-800 text-gray-300 border border-gray-600 hover:bg-gray-700"}`
                              : `${value > 0
                                ? "bg-gradient-to-b from-indigo-100 to-indigo-300 border border-indigo-300 text-gray-900"
                                : "bg-white text-gray-800 border border-gray-200 hover:bg-indigo-50"}`
                            }`}
                          title={`${year}-${month + 1}-${day}`}
                        >
                          <div className="text-[11px] font-bold">{day}</div>

                       {dayTasks.length > 0 && (
  <div className={`text-[10px] truncate mt-1 font-medium px-1 rounded ${darkMode ? "bg-white/20 text-indigo-100" : "bg-indigo-50 text-indigo-800"}`}>
    {dayTasks[0]?.time ? `â° ${dayTasks[0].time} ` : ""}{dayTasks[0]?.title || ""}
    {dayTasks.length > 1 ? ` ì™¸ ${dayTasks.length - 1}` : ""}
  </div>
)}

                          <div className="text-[11px]">{value.toLocaleString()}ì</div>
                        </div>

                      );
                    })}
                  </div>

                  {/* ğŸ“‹ ì´ë²ˆ ë‹¬ ì¼ì • ìš”ì•½ */}
                  <div
                    className={`mt-6 p-4 rounded-lg text-sm ${darkMode
                        ? "bg-gray-800 text-gray-200 border border-gray-700"
                        : "bg-indigo-50 text-gray-900 border border-gray-200"
                      }`}
                  >
                    <h3 className="font-semibold text-indigo-700 mb-2">ğŸ—’ ì´ë²ˆ ë‹¬ ì¼ì • ìš”ì•½</h3>
                    {(() => {
  // calendarTasks: { "YYYY-MM-DD": [ {title,time,...} | "legacy-string" ] }
  const monthEvents = Object.entries(calendarTasks || {})
    .map(([date, items]) => [date, normalizeTasks(items)])
    .filter(([date]) => {
      const d = new Date(date);
      return d.getFullYear() === year && d.getMonth() === month;
    })
    .sort(([a], [b]) => new Date(a) - new Date(b));

  if (monthEvents.length === 0)
    return <p className="text-gray-500 text-sm">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>;

  return (
    <ul className="divide-y divide-gray-300">
      {monthEvents.map(([date, items]) => (
        <li key={date} className="py-1 flex justify-between">
          <span className="text-indigo-600 font-medium">{date.slice(5)}</span>
          <span className="text-gray-700">
            {items.map((t) => (t.time ? `${t.time} ${t.title}` : t.title)).join(", ")}
          </span>
        </li>
      ))}
    </ul>
  );
})()}

                  </div>



                  {/* ğŸ“ˆ ì›”ê°„ ìš”ì•½ */}
                  <div className={`mt-6 p-4 rounded-lg text-sm ${darkMode ? "bg-gray-800 text-gray-200 border border-gray-700" : "bg-indigo-50 text-gray-900 border border-gray-200"
                    }`}>

                    <div className="flex justify-between">
                      <span>ì´í•©</span>
                      <span className="font-semibold text-indigo-700">
                        {total.toLocaleString()}ì
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span>ì‘ì„±ì¼ ìˆ˜</span>
                      <span>{daysWritten}ì¼</span>
                    </div>
                    <div className="flex justify-between">
                      <span>ì¼í‰ê· </span>
                      <span>{avg.toLocaleString()}ì</span>
                    </div>
                    <div className="flex justify-between">
                      <span>ëª©í‘œ ë‹¬ì„±ë¥ </span>
                      <span className="font-semibold text-green-600">
                        {progress.toFixed(1)}%
                      </span>
                    </div>
                  </div>
                </div>
              );
            })()}
          </div>
          {/* âœ… ë‚ ì§œë³„ íˆ¬ë‘ ëª¨ë‹¬ */}
{todoModalOpen && todoModalDate && (() => {
  const list = normalizeTasks(calendarTasks[todoModalDate] || []);

  const close = () => {
    setTodoModalOpen(false);
    setTodoModalDate(null);
  };

  const addTask = () => {
    const title = prompt("í•  ì¼(ì œëª©)");
    if (!title) return;

    const time = prompt("ì‹œê°„ (ì˜ˆ: 09:30) / ë¹„ìš°ë©´ ì¢…ì¼", "");
    const remindMinRaw = prompt("ëª‡ ë¶„ ì „ì— ì•Œë¦¼? (0ì´ë©´ ì—†ìŒ)", "0");
    const remindMin = Math.max(0, Number(remindMinRaw || 0));

    const newTask = {
      id: Date.now(),
      title: title.trim(),
      time: (time || "").trim(),
      remindMin,
      done: false,
    };

    setCalendarTasks((prev) => {
      const copy = { ...(prev || {}) };
      copy[todoModalDate] = [...(copy[todoModalDate] || []), newTask];
      return copy;
    });
  };

  const toggleDone = (idx) => {
    setCalendarTasks((prev) => {
      const copy = { ...(prev || {}) };
      const arr = normalizeTasks(copy[todoModalDate] || []);
      arr[idx] = { ...arr[idx], done: !arr[idx].done };
      copy[todoModalDate] = arr;
      return copy;
    });
  };

  const editTask = (idx) => {
    const cur = list[idx];
    const newTitle = prompt("ì œëª© ìˆ˜ì •", cur.title);
    if (!newTitle) return;
    const newTime = prompt("ì‹œê°„ ìˆ˜ì • (ë¹„ìš°ë©´ ì¢…ì¼)", cur.time || "");
    const newRemind = prompt("ì•Œë¦¼(ë¶„) ìˆ˜ì • (0ì´ë©´ ì—†ìŒ)", String(cur.remindMin || 0));

    setCalendarTasks((prev) => {
      const copy = { ...(prev || {}) };
      const arr = normalizeTasks(copy[todoModalDate] || []);
      arr[idx] = {
        ...arr[idx],
        title: newTitle.trim(),
        time: (newTime || "").trim(),
        remindMin: Math.max(0, Number(newRemind || 0)),
      };
      copy[todoModalDate] = arr;
      return copy;
    });
  };

  const delTask = (idx) => {
    if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
    setCalendarTasks((prev) => {
      const copy = { ...(prev || {}) };
      const arr = normalizeTasks(copy[todoModalDate] || []);
      arr.splice(idx, 1);
      if (arr.length === 0) delete copy[todoModalDate];
      else copy[todoModalDate] = arr;
      return copy;
    });
  };

  // ì‹œê°„ìˆœ ì •ë ¬(ì¢…ì¼ì€ ì•„ë˜)
  const sorted = [...list].sort((a, b) => {
    const at = a.time || "99:99";
    const bt = b.time || "99:99";
    return at.localeCompare(bt);
  });

  return (
    <div className="fixed inset-0 z-[999] flex items-center justify-center bg-black/40 p-4">
      <div className={`w-full max-w-lg rounded-xl p-4 shadow-xl border ${
        darkMode ? "bg-gray-850 text-gray-100 border-gray-700" : "bg-white text-gray-900 border-gray-200"
      }`}>
        <div className="flex items-center justify-between mb-3">
          <div className="font-semibold">ğŸ“Œ {todoModalDate} ì¼ì •</div>
          <button onClick={close} className="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700">
            ë‹«ê¸°
          </button>
        </div>

        <div className="flex justify-end mb-3">
          <button onClick={addTask} className="bg-blue-500 text-white px-3 py-1 rounded">
            + íˆ¬ë‘ ì¶”ê°€
          </button>
        </div>

        {sorted.length === 0 ? (
          <div className="text-sm opacity-70">ì•„ì§ ë“±ë¡ëœ íˆ¬ë‘ê°€ ì—†ì–´ìš”.</div>
        ) : (
          <ul className="space-y-2">
            {sorted.map((t, i) => (
              <li key={t.id || i} className={`p-2 rounded border ${
                darkMode ? "bg-gray-800 border-gray-700" : "bg-gray-50 border-gray-200"
              }`}>
                <div className="flex items-start justify-between gap-2">
                  <label className="flex items-start gap-2 cursor-pointer">
                    <input type="checkbox" checked={!!t.done} onChange={() => toggleDone(i)} />
                    <div>
                      <div className={`${t.done ? "line-through opacity-60" : ""}`}>
                        {t.time ? `[${t.time}] ` : "[ì¢…ì¼] "}{t.title}
                      </div>
                      <div className="text-xs opacity-70">
                        {t.remindMin ? `ğŸ”” ${t.remindMin}ë¶„ ì „ ì•Œë¦¼` : "ğŸ”• ì•Œë¦¼ ì—†ìŒ"}
                      </div>
                    </div>
                  </label>

                  <div className="flex gap-2">
                    <button className="text-yellow-600 text-sm" onClick={() => editTask(i)}>ìˆ˜ì •</button>
                    <button className="text-red-600 text-sm" onClick={() => delTask(i)}>ì‚­ì œ</button>
                  </div>
                </div>
              </li>
            ))}
          </ul>
        )}
      </div>
    </div>
  );
})()}


  
      {/* ğŸ“œ ê³„ì•½ ê´€ë¦¬ ì„¹ì…˜ */}
<div id="contract-section">
  <ContractSection darkMode={darkMode} />
</div>


          {/* ğŸ’° ì¸ì„¸ ê´€ë¦¬ ì„¹ì…˜ */}
          <RoyaltySection darkMode={darkMode} />


 {/* ğŸ“Š ì›”ë³„ ì¸ì„¸ ê·¸ë˜í”„ */}
<div className="mt-6">
  <h3 className="font-semibold mb-2 text-indigo-700">ğŸ“ˆ ì›”ë³„ ì¸ì„¸ ì¶”ì´</h3>

  {(() => {
    const royalties = JSON.parse(
      localStorage.getItem("writer_royalties") || "[]"
    );

    const months = Object.entries(
      royalties.reduce((acc, r) => {
        const ym = normalizeDate(r.date).slice(0, 7);
        acc[ym] = (acc[ym] || 0) + Number(r.amount || 0);
        return acc;
      }, {})
    ).sort(([a], [b]) => a.localeCompare(b));

    if (months.length === 0) {
      return (
        <p className="text-sm text-gray-500">
          ë“±ë¡ëœ ì¸ì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
        </p>
      );
    }

    // âœ… ìµœê·¼ 12ê°œì›”
    const recentMonths = months.slice(-12);
    const maxRoyaltyVal = Math.max(
      ...recentMonths.map(([_, v]) => v),
      1
    );

    return (
      <div className="flex items-end gap-2 h-48 p-3 rounded-lg overflow-x-auto bg-gray-50 dark:bg-gray-800">
        {recentMonths.map(([m, val], i) => (
          <div
            key={i}
            className="flex flex-col items-center justify-end flex-1 min-w-[36px]"
          >
            <div
              className="bg-indigo-500 rounded-t w-6"
              style={{ height: `${(val / maxRoyaltyVal) * 160}px` }}
            />
            <span className="text-[11px] mt-1">{m}</span>
             {/* âœ… ì¶”ê°€: ì›”ë³„ ê¸ˆì•¡ í‘œì‹œ */}
    <span
      className={`text-[10px] leading-none ${
        darkMode ? "text-indigo-300" : "text-indigo-600"
      }`}
    >
      {Number(val).toLocaleString()}
    </span>
          </div>
        ))}
      </div>
    );
  })()}
</div>



          {/* ğŸ“† ì—°ë„ë³„ ì¸ì„¸ í†µê³„ */}
          <div className="mt-8">
            <h3 className="font-semibold mb-2 text-indigo-700">ğŸ“† ì—°ë„ë³„ ì¸ì„¸ í†µê³„</h3>
            <div className={`flex items-end gap-3 h-48 p-3 rounded-lg overflow-x-auto ${darkMode ? "bg-gray-800" : "bg-gray-50"
              }`}>
              {Object.entries(grouped.byYear)
                .sort(([a], [b]) => Number(a) - Number(b))
                .map(([year, total], i) => {
                  const maxYearVal = Math.max(...Object.values(grouped.byYear), 1);
                  return (
                    <div key={i} className="flex flex-col items-center justify-end flex-1">
                      <div
                        className="bg-green-500 rounded-t w-8"
                        style={{ height: `${(total / maxYearVal) * 160}px` }}
                      />
                      <span className="text-[11px] mt-1">{year}</span>
                      <span className="text-[10px] text-green-300">{Number(total).toLocaleString()}</span>
                    </div>
                  );
                })}
            </div>
          </div>

          {/* ğŸ¨ ì‘í’ˆë³„ ì¸ì„¸ í†µê³„ */}
          <div className="mt-8">
            <h3 className="font-semibold mb-2 text-indigo-700">ğŸ¨ ì‘í’ˆë³„ ì¸ì„¸ í†µê³„</h3>
            <div className={`grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 ${darkMode ? "text-gray-200" : "text-gray-800"
              }`}>
              {Object.entries(grouped.byTitle)
                .sort(([, a], [, b]) => b - a)
                .map(([title, total], i) => {
                  const maxTitle = Math.max(...Object.values(grouped.byTitle), 1);
                  return (
                    <div
  key={i}
  onClick={() => setActiveRoyaltyProject(title)}
  className={`p-3 rounded-lg border cursor-pointer hover:shadow-md transition ${
    darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-200"
  }`}
>
                      <div className="font-semibold truncate">{title}</div>
                      <div className="text-sm text-indigo-400">{Number(total).toLocaleString()} ì›</div>
                      <div
                        className="mt-1 h-2 bg-indigo-500 rounded"
                        style={{ width: `${(total / maxTitle) * 100}%` }}
                      />
                    </div>
                  );
                })}
            </div>
          </div>
    {/* ğŸ“Œ ì‘í’ˆë³„ ì—°ë„ë³„ ì¸ì„¸ ëª¨ë‹¬ */}
{activeRoyaltyProject && (
  <div
    className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50"
    onClick={() => setActiveRoyaltyProject(null)}
  >
    <div
      className={`rounded-lg p-5 w-80 relative ${
        darkMode ? "bg-gray-800 text-gray-200" : "bg-white text-gray-900"
      }`}
      onClick={(e) => e.stopPropagation()}
    >
      <button
        className="absolute right-3 top-3 text-gray-400 hover:text-gray-200"
        onClick={() => setActiveRoyaltyProject(null)}
      >
        âœ•
      </button>

      <h2 className="text-lg font-bold text-indigo-400 mb-4">
        {activeRoyaltyProject} ì—°ë„ë³„ ìˆ˜ì…
      </h2>

      {(() => {
        const royalties = JSON.parse(localStorage.getItem("writer_royalties") || "[]");
        const filtered = royalties.filter(
          (r) => r.title === activeRoyaltyProject
        );

        const byYear = filtered.reduce((acc, r) => {
          const y = normalizeDate(r.date).slice(0, 4);
          acc[y] = (acc[y] || 0) + Number(r.amount || 0);
          return acc;
        }, {});

        const sorted = Object.entries(byYear).sort(([a], [b]) => a - b);

        if (sorted.length === 0)
          return <p className="text-sm text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>;

        return (
          <div className="space-y-2">
            {sorted.map(([year, total]) => (
              <div
                key={year}
                className="flex justify-between items-center border-b py-1"
              >
                <span className="text-indigo-300 font-medium">{year}ë…„</span>
                <span>{Number(total).toLocaleString()} ì›</span>
              </div>
            ))}
          </div>
        );
      })()}
    </div>
  </div>
)}

          {/* ğŸ© ìœ í˜•ë³„ ì¸ì„¸ ë¹„ì¤‘ */}
          <div className="mt-10">
            <h3 className="font-semibold mb-2 text-indigo-700">ğŸ© ìœ í˜•ë³„ ì¸ì„¸ ë¹„ì¤‘</h3>

            {(() => {
              const typeTotals = {};
              royalties.forEach((r) => {
                typeTotals[r.type] = (typeTotals[r.type] || 0) + Number(r.amount || 0);
              });

              const entries = Object.entries(typeTotals);
              const totalSum = entries.reduce((a, [, v]) => a + v, 0);

              if (entries.length === 0) {
                return <p className="text-sm text-gray-500">ë“±ë¡ëœ ì¸ì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>;
              }

              return (
                <div
                  className={`flex flex-col md:flex-row items-center justify-center gap-6 p-4 rounded-lg ${darkMode ? "bg-gray-800 text-gray-200" : "bg-gray-50 text-gray-900"
                    }`}
                >
                  {/* ğŸ© ë„ë„› ì°¨íŠ¸ */}
                  <svg viewBox="0 0 36 36" className="w-40 h-40 transform -rotate-90">
                    {(() => {
                      let cumulative = 0;
                      const colors = [
                        "#818CF8", // ìœ ì—°
                        "#34D399", // ë‹¨í–‰
                        "#FBBF24", // ì´ˆë‹¨
                        "#F87171", // ê¸°íƒ€
                      ];

                      return entries.map(([type, val], i) => {
                        const ratio = val / totalSum;
                        const start = cumulative * 100;
                        const end = start + ratio * 100;
                        cumulative += ratio;
                        return (
                          <circle
                            key={i}
                            r="15.9155"
                            cx="18"
                            cy="18"
                            fill="transparent"
                            stroke={colors[i % colors.length]}
                            strokeWidth="3.5"
                            strokeDasharray={`${end - start} ${100 - (end - start)}`}
                            strokeDashoffset={-start}
                          />
                        );
                      });
                    })()}
                  </svg>

                  {/* ğŸ§¾ í•­ëª©ë³„ í‘œê¸° */}
                  <ul className="text-sm space-y-1 text-left">
                    {entries.map(([type, val], i) => {
                      const percent = ((val / totalSum) * 100).toFixed(1);
                      const colorClass = [
                        "text-indigo-400",
                        "text-green-400",
                        "text-yellow-400",
                        "text-red-400",
                      ][i % 4];
                      return (
                        <li key={i} className="flex items-center gap-2">
                          <span className={`w-3 h-3 rounded-full ${colorClass}`}>â—</span>
                          <span className="font-medium w-12">{type}</span>
                          <span className="text-gray-400">{val.toLocaleString()}ì›</span>
                          <span className="ml-2 text-gray-500">({percent}%)</span>
                        </li>
                      );
                    })}
                  </ul>
                </div>
      
              );
            })()}
          </div>

         

       </div>
      );
    }

function TodoModal({ open, dateKey, onClose, darkMode, calendarTasks, setCalendarTasks }) {
  const [title, setTitle] = React.useState("");
  const [time, setTime] = React.useState("");
  const [remindMin, setRemindMin] = React.useState(10);

  React.useEffect(() => {
    if (open) {
      setTitle("");
      setTime("");
      setRemindMin(10);
    }
  }, [open]);

  if (!open || !dateKey) return null;

  const list = calendarTasks[dateKey] || [];

  const addTask = () => {
    const t = title.trim();
    if (!t) return;

    const newTask = {
      id: Date.now(),
      title: t,
      time: (time || "").trim(),      // ""ì´ë©´ ì¢…ì¼
      remindMin: Math.max(0, Number(remindMin || 0)),
      done: false,
    };

    setCalendarTasks((prev) => {
      const copy = { ...prev };
      copy[dateKey] = [...(copy[dateKey] || []), newTask];
      return copy;
    });

    setTitle("");
    setTime("");
    setRemindMin(10);
  };

  const toggleDone = (id) => {
    setCalendarTasks((prev) => {
      const copy = { ...prev };
      copy[dateKey] = (copy[dateKey] || []).map((t) => (t.id === id ? { ...t, done: !t.done } : t));
      return copy;
    });
  };

  const delTask = (id) => {
    setCalendarTasks((prev) => {
      const copy = { ...prev };
      const next = (copy[dateKey] || []).filter((t) => t.id !== id);
      if (next.length === 0) delete copy[dateKey];
      else copy[dateKey] = next;
      return copy;
    });
  };

  return (
    <div className="fixed inset-0 z-[999] flex items-center justify-center bg-black/50">
      <div className={`w-[92vw] max-w-lg rounded-xl p-4 shadow-xl border ${darkMode ? "bg-gray-900 text-gray-100 border-gray-700" : "bg-white text-gray-900 border-gray-200"}`}>
        <div className="flex items-center justify-between mb-3">
          <div className="font-semibold">ğŸ“… {dateKey} ì¼ì •</div>
          <button onClick={onClose} className="px-3 py-1 rounded bg-gray-200 text-gray-900">ë‹«ê¸°</button>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2">
          <input
            className={`px-3 py-2 rounded border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-300"}`}
            placeholder="í•  ì¼"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
          />
          <input
            className={`px-3 py-2 rounded border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-300"}`}
            placeholder="ì‹œê°„(ì˜ˆ: 09:30)"
            value={time}
            onChange={(e) => setTime(e.target.value)}
          />
          <input
            type="number"
            className={`px-3 py-2 rounded border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-300"}`}
            placeholder="ì•Œë¦¼(ë¶„)"
            value={remindMin}
            onChange={(e) => setRemindMin(e.target.value)}
            min={0}
          />
        </div>

        <button onClick={addTask} className="w-full mb-3 px-3 py-2 rounded bg-indigo-600 text-white">
          + ì¶”ê°€
        </button>

        <div className={`max-h-[45vh] overflow-y-auto rounded border ${darkMode ? "border-gray-700" : "border-gray-200"}`}>
          {list.length === 0 ? (
            <div className="p-3 text-sm opacity-70">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          ) : (
            <ul className="divide-y divide-gray-200 dark:divide-gray-700">
              {list.map((t) => (
                <li key={t.id} className="p-3 flex items-center justify-between gap-3">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" checked={!!t.done} onChange={() => toggleDone(t.id)} />
                    <div>
                      <div className={t.done ? "line-through opacity-60" : ""}>
                        {t.time ? `â° ${t.time} ` : ""}{t.title}
                      </div>
                      <div className="text-xs opacity-70">
                        {t.remindMin ? `ğŸ”” ${t.remindMin}ë¶„ ì „` : "ğŸ”• ì•Œë¦¼ ì—†ìŒ"}
                      </div>
                    </div>
                  </label>
                  <button onClick={() => delTask(t.id)} className="text-rose-500 text-sm">ì‚­ì œ</button>
                </li>
              ))}
            </ul>
          )}
        </div>

        <div className="mt-3 text-xs opacity-60">
          ì´ ë‚ ì§œì— ë„£ì€ íˆ¬ë‘ëŠ” ìº˜ë¦°ë” ì…€ì—ë„ ì²« í•­ëª©ì´ ë¯¸ë¦¬ë³´ê¸°ë¡œ ë– ìš”.
        </div>
      </div>
      <TodoModal
  open={todoModalOpen}
  dateKey={todoModalDate}
  onClose={() => setTodoModalOpen(false)}
  darkMode={darkMode}
/>
    </div>
  );
}


    window.PlannerApp = PlannerApp;

  
  </script>
  <!-- âš¡ Firebase ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í›„ React ë Œë”ë§ (ES Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDDaQFVkQMG63wI7guyMPygx9QwaokMu7I",
      authDomain: "writer-planner.firebaseapp.com",
      projectId: "writer-planner",
      storageBucket: "writer-planner.firebasestorage.app",
      messagingSenderId: "590639652717",
      appId: "1:590639652717:web:bc69fa99d82f6c5e760464"
    };
const normalizeTasks = (raw) =>
  (raw || []).map((t, idx) =>
    typeof t === "string"
      ? { id: "legacy_" + idx, title: t, time: "", remindMin: 0, done: false }
      : t
  );

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ë¡œê·¸ì¸ ë²„íŠ¼
    const loginButton = document.createElement("button");
    loginButton.innerText = "ğŸ”‘ Google ë¡œê·¸ì¸";
    loginButton.className = "fixed bottom-5 right-5 bg-indigo-500 text-white px-4 py-2 rounded-lg shadow";
    document.body.appendChild(loginButton);

    // ë¡œê·¸ì¸
    loginButton.onclick = () => signInWithPopup(auth, provider);

    // ğŸŒŸ ë¡œê·¸ì¸ ë²„íŠ¼ ìœ„ ì„¸ë¡œí˜• ë¶ë§ˆí¬ ë²„íŠ¼ë°”
    const bookmarkNav = document.createElement("div");
    bookmarkNav.className =
      "fixed bottom-24 right-5 flex flex-col gap-3 items-end z-50";

    // ë²„íŠ¼ ëª©ë¡ ì •ì˜
    
    const buttons = [
      { id: "top", label: "ë§¨ ìœ„" }, // â¬…ï¸ ìƒˆë¡œ ì¶”ê°€ëœ ë²„íŠ¼
      { id: "log-section", label: "ë¡œê·¸" },
      { id: "project-progress-section", label: "ì§„í–‰ë¥ " },
      { id: "goal-section", label: "íƒ€ì„ë¼ì¸" },
      { id: "monthly-section", label: "ì›”ê°„" },
      { id: "calendar-section", label: "ìº˜ë¦°ë”" },
      { id: "contract-section", label: "ê³„ì•½" },
      { id: "royalty-section", label: "ì¸ì„¸" },
    ];


    buttons.forEach(({ id, label }) => {
      const btn = document.createElement("button");
      btn.innerText = label;
      btn.className =
        "bg-gray-700 hover:bg-indigo-500 text-white rounded-full px-4 py-2 shadow-md transition";
      btn.onclick = () => {
        if (id === "top") {
          window.scrollTo({ top: 0, behavior: "smooth" });
        } else {
          const section = document.getElementById(id);
          if (section) section.scrollIntoView({ behavior: "smooth" });
        }
      };
      bookmarkNav.appendChild(btn);
    });

    document.body.appendChild(bookmarkNav);

// âœ… planner ë³‘í•©ì„ ì „ì—­(window)ìœ¼ë¡œ ë“±ë¡í•´ì„œ ì–´ë””ì„œë“  í˜¸ì¶œ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°
window.dedupLogs = function (logs) {
  const seen = new Set();
  const out = [];
  for (const l of (logs || [])) {
    const key = `${l.time || ""}||${l.currentWords ?? ""}||${l.diff ?? ""}`;
    if (seen.has(key)) continue;
    seen.add(key);
    out.push(l);
  }
  return out;
};

window.mergePlanner = function (localPlanner, cloudPlanner) {
  const merged = { ...(cloudPlanner || {}) };
  const META_KEYS = new Set(["dailySummary"]);

  const normSummary = (x) => {
    if (typeof x === "string") return x;
    if (x && typeof x === "object") {
      if (typeof x.text === "string") return x.text;
    }
    return "";
  };

  for (const [date, localDay] of Object.entries(localPlanner || {})) {
    const cloudDay = merged[date] || {};
    const dayOut = { ...cloudDay };

    // âœ… 1) dailySummaryëŠ” "ì‘í’ˆ"ì´ ì•„ë‹ˆë¼ "ë©”íƒ€"ë¡œ ë³„ë„ ë³‘í•©
    const lsum = normSummary(localDay?.dailySummary);
    const csum = normSummary(cloudDay?.dailySummary);
    dayOut.dailySummary = (lsum.length >= csum.length ? lsum : csum);

    // âœ… 2) ì‘í’ˆ ë°ì´í„°ë§Œ ë³‘í•© (meta key ì œì™¸ + ê°ì²´ë§Œ)
    for (const [proj, localProjData] of Object.entries(localDay || {})) {
      if (META_KEYS.has(proj)) continue;                 // ğŸ”¥ í•µì‹¬: dailySummary ìŠ¤í‚µ
      if (!localProjData || typeof localProjData !== "object") continue;

      const cloudProjData = dayOut[proj] || {};
      const lp = localProjData || {};
      const cp = cloudProjData || {};

      const localLogs = Array.isArray(lp.logs) ? lp.logs : [];
      const cloudLogs = Array.isArray(cp.logs) ? cp.logs : [];

      dayOut[proj] = {
        ...cp,
        ...lp,
        logs: window.dedupLogs([...cloudLogs, ...localLogs]),
        startTime: lp.startTime || cp.startTime || "",
        startWords: Number.isFinite(lp.startWords) ? lp.startWords : (cp.startWords || 0),
        goal: Number.isFinite(lp.goal) ? lp.goal : (cp.goal || 0),
        memo:
          String(lp.memo || "").length >= String(cp.memo || "").length
            ? (lp.memo || "")
            : (cp.memo || ""),
      };
    }

    merged[date] = dayOut;
  }

  return merged;
};


    // ë¡œê·¸ì¸ ìƒíƒœ ê°ì‹œ
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        if (window.cloudLoaded) return;
        window.cloudLoaded = true;

        loginButton.innerText = `ğŸ‘‹ ${user.displayName}ë‹˜`;
        loginButton.disabled = true;

        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const cloudData = snap.data();
          if (cloudData) {
  // âœ… plannerëŠ” í´ë¼ìš°ë“œë¡œ ë®ì–´ì“°ê¸° ê¸ˆì§€! ë¡œì»¬ê³¼ ë³‘í•©í•´ì„œ ë³´ì¡´
{
  const localPlanner = JSON.parse(localStorage.getItem("writer_planner_store_v4") || "{}");
  const cloudPlanner = cloudData.planner || {};
  const mergedPlanner = window.mergePlanner(localPlanner, cloudPlanner);
  {
  const localPlanner = JSON.parse(localStorage.getItem("writer_planner_store_v4") || "{}");
  const cloudPlanner = cloudData.planner || {};
  const mergedPlanner = window.mergePlanner(localPlanner, cloudPlanner);
  localStorage.setItem("writer_planner_store_v4", JSON.stringify(mergedPlanner));
}
}


  if (cloudData.contracts)
    localStorage.setItem("writer_contracts_v1", JSON.stringify(cloudData.contracts));

  // âœ… ìº˜ë¦°ë”ëŠ” "í´ë¼ìš°ë“œë¡œ ë®ì–´ì“°ê¸°" ê¸ˆì§€! ë¡œì»¬ê³¼ ë³‘í•©í•´ì„œ ë³´ì¡´
{
  const localCal = JSON.parse(localStorage.getItem("calendar_tasks") || "{}");
  const cloudCal = cloudData.calendar || {};

  const merged = (() => {
    const out = { ...cloudCal };

    const normalize = (arr) =>
      (arr || []).map((t, idx) =>
        typeof t === "string"
          ? { id: "legacy_" + idx, title: t, time: "", remindMin: 0, done: false }
          : t
      );

    const dedup = (arr) => {
      const seen = new Set();
      return arr.filter((t) => {
        const key = `${t.title || ""}||${t.time || ""}||${t.remindMin ?? ""}`;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    };

    // ë¡œì»¬ í‚¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ cloudì™€ í•©ì¹˜ë˜, ì¤‘ë³µì€ ì œê±°
    for (const [date, localArr] of Object.entries(localCal || {})) {
      const a = normalize(out[date]);
      const b = normalize(localArr);
      out[date] = dedup([...a, ...b]);
    }

    return out;
  })();

  localStorage.setItem("calendar_tasks", JSON.stringify(merged));
}


  if (cloudData.royalties) {
    const local = JSON.parse(localStorage.getItem("writer_royalties") || "[]");
const cloud = cloudData.royalties || [];

// ë‚ ì§œ+ì œëª© ì™„ì „ ê°™ì€ ì¤‘ë³µ ì œê±° í›„ ë³‘í•©
const merged = [...local, ...cloud].reduce((acc, cur) => {
  const key = cur.date + cur.title + cur.amount;
  if (!acc.map.has(key)) {
    acc.map.set(key, true);
    acc.list.push(cur);
  }
  return acc;
}, { map: new Map(), list: [] }).list;

localStorage.setItem("writer_royalties", JSON.stringify(merged));
    window.dispatchEvent(new Event("royaltyDataUpdated"));
  }

  if (cloudData.targets)
    localStorage.setItem("writer_targets", JSON.stringify(cloudData.targets));
          console.info("â˜ï¸ í´ë¼ìš°ë“œ ë°ì´í„° ë¶ˆëŸ¬ì˜´ (planner + contracts + targets)"); // âœ… ë¬¸êµ¬ ìˆ˜ì •
        } else {
          await setDoc(ref, {});
        }
   if (cloudData.projects)
    localStorage.setItem("writer_projects", JSON.stringify(cloudData.projects));
}

        // âœ… ìë™ ë°±ì—… (ëª©í‘œ í¬í•¨)
                setInterval(async () => {
          const planner   = JSON.parse(localStorage.getItem("writer_planner_store_v4") || "{}");
          const contracts = JSON.parse(localStorage.getItem("writer_contracts_v1") || "[]");
          const targets   = JSON.parse(localStorage.getItem("writer_targets") || "{}");
          const calendar  = JSON.parse(localStorage.getItem("calendar_tasks") || "{}");
          const royalties = JSON.parse(localStorage.getItem("writer_royalties") || "[]");
          const projects  = JSON.parse(localStorage.getItem("writer_projects") || "[]"); // âœ… ì¶”ê°€

          await setDoc(ref, { planner, contracts, targets, calendar, royalties, projects });

          console.log("âœ… í´ë¼ìš°ë“œ ìë™ ë°±ì—… ì™„ë£Œ (planner + contracts + targets + projects)");
        }, 30000);


        // âœ… ë¡œê·¸ì¸ í›„ì—ë§Œ React ì•± ì‹¤í–‰
        if (!window.reactStarted) {
          window.reactStarted = true;

          // ğŸ”¹ Babel ë³€í™˜ì´ ëë‚¬ëŠ”ì§€ í™•ì¸ í›„ ì‹¤í–‰
          const waitForPlannerApp = setInterval(() => {
            if (window.PlannerApp) {
              clearInterval(waitForPlannerApp);
              const root = ReactDOM.createRoot(document.getElementById("root"));
              root.render(React.createElement(window.PlannerApp));
            }
          }, 200);
        }

      } else {
        console.log("ë¡œê·¸ì¸ í•„ìš”");
      }
    });
  </script>

<script>
  // âœ… ë‚ ì§œ í‚¤
  function getTodayKey() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${da}`;
  }

  // âœ… ë¹ ë¥¸ ë©”ëª¨ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° (í•˜ë£¨ ë‹¨ìœ„)
  (function () {
    const textarea = document.getElementById("quickMemoInput");
    if (!textarea) return;

    const key = "quick_memo_" + getTodayKey();

    const saved = localStorage.getItem(key);
    if (saved !== null) textarea.value = saved;

    textarea.addEventListener("input", () => {
      localStorage.setItem(key, textarea.value);
    });
  })();

  // âœ… ì™¼ìª½ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°
  (function () {
    const panel = document.getElementById("quick-memo");
    const btn = document.getElementById("quick-memo-toggle");
    if (!panel || !btn) return;

    const LS_KEY = "quick_memo_collapsed";

    function apply(collapsed) {
      panel.classList.toggle("is-collapsed", collapsed);
      btn.textContent = collapsed ? "â¯" : "â®";
      btn.title = collapsed ? "íŒ¨ë„ í¼ì¹˜ê¸°" : "íŒ¨ë„ ì ‘ê¸°";
      btn.setAttribute(
        "aria-label",
        collapsed ? "ì™¼ìª½ íŒ¨ë„ í¼ì¹˜ê¸°" : "ì™¼ìª½ íŒ¨ë„ ì ‘ê¸°"
      );
    }

    // ì´ˆê¸° ìƒíƒœ ë³µì›
    apply(localStorage.getItem(LS_KEY) === "1");

    // í´ë¦­ í† ê¸€
    btn.addEventListener("click", () => {
      const next = !panel.classList.contains("is-collapsed");
      apply(next);
      localStorage.setItem(LS_KEY, next ? "1" : "0");
    });
  })();
</script>

<script>
  // ğŸ”¹ ë¡œê·¸ì¸ í›„ì—ë„ ìœ ì§€ (React ë Œë”ë§ ì˜í–¥ ì—†ìŒ)
  window.addEventListener("DOMContentLoaded", () => {
    const memoBox = document.getElementById("quickMemoInput");
    if (!memoBox) return;

    const saved = localStorage.getItem("writer_quickmemo") || "";
    memoBox.value = saved;
  });
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

  // ğŸ”¥ 1) Firebase ì´ˆê¸°í™” (ì´ë¯¸ ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ë³µë¶™í•˜ë˜ ì¤‘ë³µ ì´ˆê¸°í™”í•˜ì§€ ì•Šê²Œ ì¡°ì •)
  const firebaseConfig = {
    apiKey: "YOUR_KEY",
    authDomain: "YOUR_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const memoBox = document.getElementById("quickMemoInput");

  // ğŸ”¹ ë¨¼ì € localStorageì—ì„œ ì¦‰ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (í™”ë©´ì— ë¹ˆì¹¸ ë°©ì§€)
  const localBackup = localStorage.getItem("writer_quickmemo") || "";
  memoBox.value = localBackup;

  let currentUid = null;
  let unsubscribe = null; // Firestore ì‹¤ì‹œê°„ ìˆ˜ì‹  í•´ì œ í•¨ìˆ˜

  // ğŸ”¥ 2) ë¡œê·¸ì¸ ê°ì§€
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUid = user.uid;
      const memoRef = doc(db, "users", currentUid, "memo", "quick");

      // ğŸ”¥ 3) Firestore ì‹¤ì‹œê°„ ë°˜ì˜
      unsubscribe = onSnapshot(memoRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.data();
          memoBox.value = data.text || "";
          localStorage.setItem("writer_quickmemo", memoBox.value);
        }
      });

      // ğŸ”¥ 4) Firestoreì— ë¬¸ì„œê°€ ì—†ë‹¤ë©´ ìƒì„±
      const memoDoc = await getDoc(memoRef);
      if (!memoDoc.exists()) {
        await setDoc(memoRef, {
          text: localBackup,
          updatedAt: new Date()
        });
      }

    } else {
      // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ â†’ localStorageë§Œ ì‚¬ìš©
      currentUid = null;
      if (unsubscribe) unsubscribe();
    }
  });

  // ğŸ”¥ 5) ì…ë ¥ ì‹œ Firestore & localStorageì— ìë™ ì €ì¥
  memoBox.addEventListener("input", async () => {
    const value = memoBox.value;
    localStorage.setItem("writer_quickmemo", value);

    if (!currentUid) return; // ë¡œê·¸ì¸ ì „ì´ë©´ Firestore ì €ì¥ ì•ˆ í•¨

    const memoRef = doc(db, "users", currentUid, "memo", "quick");
    await setDoc(memoRef, {
      text: value,
      updatedAt: new Date()
    });
  });
</script>

</body>

</html>